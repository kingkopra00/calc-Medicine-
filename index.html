<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة التوزيعات - نسخة سريعة ومستقرة</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --main-bg: #1a1c23; --panel-bg: #252934; --accent: #007bff;
            --border: #3a3f4b; --text: #f0f0f0; --muted: #a0a0a0; --success: #28a745; --danger: #dc3545;
        }
        body { background: var(--main-bg); color: var(--text); margin: 0; font-family: "Tajawal", "Segoe UI", Arial, sans-serif; font-size: 16px; }
        main { max-width: 1000px; margin: 20px auto; padding: 1rem; }
        h1, h2, h3 { text-align: center; font-weight: 700; margin-bottom: 1em; }
        footer { text-align: center; margin-top: 2em; padding: 1em; color: var(--muted); border-top: 1px solid var(--border); }
        .section { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 1.5em; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 1em; align-items: end; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: var(--muted); }
        input, select { width: 100%; padding: 10px; background: var(--main-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .btn { background: var(--panel-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 10px 20px; font-size: 1em; cursor: pointer; width: 100%; transition: background-color 0.2s, border-color 0.2s; }
        .btn:hover { border-color: var(--accent); }
        .btn-primary { background: var(--accent); color: #fff; border: none; }
        .btn-danger { background-color: var(--danger); color: #fff; border: none; }
        #data-status { text-align: center; color: var(--accent); font-weight: bold; margin-bottom: 1em; min-height: 1.2em; }
        .search-wrapper { position: relative; }
        #suggestions-container {
            position: absolute; background-color: #2d3241; border: 1px solid var(--border);
            border-radius: 8px; width: 100%; z-index: 1000; max-height: 40vh; overflow-y: auto; top: 100%;
        }
        #suggestions-container.suggestions-above { top: auto; bottom: 100%; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #3a3f4b; }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1001; }
        .options-row { display: flex; align-items: center; gap: 10px; margin-top: 15px; padding: 12px; background: #2d3241; border-radius: 8px; }
        .results-summary { text-align: center; font-size: 1.1em; margin-bottom: 1em; background: #2d3241; padding: 10px; border-radius: 8px; }
        .results-table { width: 100%; border-collapse: collapse; font-size: 0.95em; margin-top: 1em; table-layout: fixed; }
        .results-table th, .results-table td { border-bottom: 1px solid var(--border); padding: 12px 8px; text-align: center; word-wrap: break-word; }
        .results-table tfoot td { font-weight: bold; border-top: 2px solid var(--accent); }
        #institutions-toggle-list { padding: 10px; border: 1px solid var(--border); border-radius: 8px; }
        #print-header { display: none; }
        @media print {
            body { background: #fff; color: #000; font-family: Arial, sans-serif; font-size: 10pt; }
            main, .section { margin: 0; padding: 0; border: none; box-shadow: none; background: #fff; }
            .no-print { display: none !important; }
            #print-header { display: block; text-align: center; margin-bottom: 2em; }
            h1, h2 { display: none; }
            .results-table { border: 1px solid #ccc; font-size: 9pt; }
            @page { size: A4; margin: 20mm; }
        }
    </style>
</head>
<body>
    <main>
        <h1 class="no-print">📋 نظام إدارة التوزيعات</h1>
        
        <div class="section no-print">
            <h2>الخطوة 1: إدارة البيانات والبحث</h2>
            <p id="data-status"></p>
            <div class="form-row">
                <div>
                    <label>اختر سنة الاحتياج للتحميل</label>
                    <select id="year-select">
                        <option value="">-- جاري البحث عن الملفات... --</option>
                    </select>
                </div>
                <div><button id="load-from-server-btn" class="btn btn-success">🔄 تحميل من السيرفر</button></div>
                <div><label style="visibility: hidden;">.</label><button id="clear-data-btn" class="btn btn-danger" hidden>🗑️ حذف البيانات المحفوظة</button></div>
            </div>
            <hr style="border-color: var(--border); margin: 2em 0;">
            <div class="form-row">
                <div><label>... أو تحميل ملف يدويًا</label><input type="file" id="excel-file-input" accept=".xlsx, .xls"></div>
                <div><button id="load-excel-btn" class="btn">📂 تحميل وتحديث</button></div>
            </div>
            <hr style="border-color: var(--border); margin: 2em 0;">
            <div class="form-row">
                <div class="search-wrapper">
                    <label for="item-name-search">ابحث بالاسم أو بالكود</label>
                    <input type="text" id="item-name-search" placeholder="اكتب للبحث السريع...">
                    <div id="suggestions-container"></div>
                </div>
                <div><label style="visibility: hidden;">.</label><button id="search-excel-btn" class="btn btn-primary">🔍 بحث</button></div>
            </div>
        </div>
        
        <div class="section no-print" id="config-section" hidden>
            </div>
        <div class="section" id="results-section" hidden>
            </div>
        <div class="modal-bg no-print" id="multi-results-modal">
            </div>
        <footer class="no-print">
            </footer>
    </main>
    
    <script>
        let excelData = { headers: [], rows: [] };
        let selectedRowData = { row: null, institutions: [] };
        let lastResultsData = [];
        const searchInput = document.getElementById('item-name-search');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const availableQtyInput = document.getElementById('available-qty-input');
        const packageSizeInput = document.getElementById('package-size-input');
        const forceDistCheck = document.getElementById('force-full-dist-check');
        let debounceTimer;

        // --- MODIFIED: Debounced search for performance ---
        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const query = searchInput.value.trim().toLowerCase();
                suggestionsContainer.innerHTML = '';
                if (query.length < 4 || excelData.rows.length === 0) return;

                const suggestions = excelData.rows.filter(row =>
                    (row[0] && String(row[0]).toLowerCase().includes(query)) ||
                    (row[1] && String(row[1]).toLowerCase().includes(query))
                ).slice(0, 15);

                if (suggestions.length === 0) return;
                
                suggestions.forEach(row => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = `${row[0] || ''} - ${row[1] || ''}`;
                    item.onclick = () => {
                        searchInput.value = row[1];
                        suggestionsContainer.innerHTML = '';
                        document.getElementById('search-excel-btn').click();
                    };
                    suggestionsContainer.appendChild(item);
                });

                const inputRect = searchInput.getBoundingClientRect();
                const spaceBelow = window.innerHeight - inputRect.bottom;
                suggestionsContainer.classList.remove('suggestions-above');
                if (spaceBelow < suggestionsContainer.scrollHeight && inputRect.top > suggestionsContainer.scrollHeight) {
                    suggestionsContainer.classList.add('suggestions-above');
                }
            }, 300); // Wait 300ms after user stops typing
        });

        // --- MODIFIED: Year discovery with caching ---
        async function discoverAvailableYears() {
            const yearSelect = document.getElementById('year-select');
            const cacheKey = 'cachedYearsList';
            const cachedData = JSON.parse(localStorage.getItem(cacheKey));
            const now = new Date().getTime();

            // Use cache if it's less than 1 hour old
            if (cachedData && (now - cachedData.timestamp < 3600000)) {
                populateYearSelect(cachedData.years);
                return;
            }

            const apiUrl = 'https://api.github.com/repos/kingkopra00/calc-Medicine-/contents/';
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    if (response.status === 403) throw new Error('تم تجاوز حد الطلبات من GitHub. يرجى المحاولة بعد ساعة.');
                    throw new Error('فشل الاتصال بـ GitHub.');
                }
                const files = await response.json();
                const yearRegex = /^data(\d{4})\.xlsx$/;
                const availableYears = [];
                for (const file of files) {
                    const match = file.name.match(yearRegex);
                    if (match) availableYears.push(match[1]);
                }
                populateYearSelect(availableYears);
                localStorage.setItem(cacheKey, JSON.stringify({ years: availableYears, timestamp: now }));
            } catch (error) {
                console.error("Discovery Error:", error);
                yearSelect.innerHTML = `<option value="">-- ${error.message} --</option>`;
            }
        }
        
        function populateYearSelect(years) {
            const yearSelect = document.getElementById('year-select');
            yearSelect.innerHTML = '';
            if (years.length > 0) {
                years.sort((a, b) => b - a);
                yearSelect.innerHTML = '<option value="">-- اختر السنة --</option>';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = `احتياج ${year}`;
                    yearSelect.appendChild(option);
                });
            } else {
                yearSelect.innerHTML = '<option value="">-- لم يتم العثور على ملفات --</option>';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocal();
            discoverAvailableYears();
            const savedForceSetting = localStorage.getItem('forceFullDistSetting');
            if (savedForceSetting === 'true') forceDistCheck.checked = true;
            forceDistCheck.onchange = (e) => localStorage.setItem('forceFullDistSetting', e.target.checked);
        });

        // --- MODIFIED: Fetch from server with cache busting ---
        document.getElementById('load-from-server-btn').onclick = function() {
            const selectedYear = document.getElementById('year-select').value;
            if (!selectedYear) { alert('الرجاء اختيار سنة الاحتياج أولاً.'); return; }
            const excelFileUrl = `https://raw.githubusercontent.com/kingkopra00/calc-Medicine-/main/data${selectedYear}.xlsx?t=${new Date().getTime()}`;
            const statusEl = document.getElementById('data-status');
            statusEl.textContent = `جاري تحميل بيانات سنة ${selectedYear} من السيرفر...`;
            
            fetch(excelFileUrl)
                .then(response => {
                    if (!response.ok) { throw new Error('فشل تحميل الملف. تأكد من اتصالك بالإنترنت ومن وجود الملف على GitHub.'); }
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => {
                    const workbook = XLSX.read(new Uint8Array(arrayBuffer), {type: 'array'});
                    processExcelData(workbook);
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    alert(`خطأ: ${error.message}`);
                    statusEl.textContent = '⚠️ فشل تحميل البيانات.';
                });
        };
        
        function processExcelData(workbook) {
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            if (jsonData.length > 1) {
                excelData = { headers: jsonData[0] || [], rows: jsonData.slice(1) };
                saveDataToLocal(excelData);
                alert(`✅ تم تحميل وتحديث البيانات بنجاح.`);
                loadDataFromLocal();
            } else { alert("الملف فارغ أو غير صالح."); }
        }

        document.getElementById('load-excel-btn').onclick = function() {
            const fileInput = document.getElementById('excel-file-input');
            if (!fileInput.files.length) { alert("الرجاء اختيار ملف إكسل."); return; }
            const reader = new FileReader();
            reader.onload = e => {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                processExcelData(workbook);
            };
            reader.readAsBinaryString(fileInput.files[0]);
        };

        // All other functions are unchanged and complete.
        function saveDataToLocal(data) { try { localStorage.setItem('savedDistributionData', JSON.stringify(data)); } catch (e) { alert("خطأ: لا يمكن حفظ البيانات."); console.error(e); } }
        function loadDataFromLocal() {
            const savedData = localStorage.getItem('savedDistributionData');
            const statusEl = document.getElementById('data-status');
            const clearBtn = document.getElementById('clear-data-btn');
            if (savedData) {
                try {
                    excelData = JSON.parse(savedData);
                    statusEl.textContent = `✅ تم تحميل ${excelData.rows.length} صف من البيانات المحفوظة.`;
                    clearBtn.hidden = false;
                } catch (e) { statusEl.textContent = "⚠️ فشل تحميل البيانات المحفوظة."; localStorage.removeItem('savedDistributionData'); }
            } else { statusEl.textContent = "يرجى رفع ملف الإكسل للبدء."; }
        }
        document.getElementById('clear-data-btn').onclick = () => { if (confirm('هل أنت متأكد؟')) { localStorage.removeItem('savedDistributionData'); location.reload(); } };
        document.addEventListener('click', (e) => { if (!e.target.closest('.search-wrapper')) { suggestionsContainer.innerHTML = ''; } });
        document.getElementById('search-excel-btn').onclick = function() { /* ... unchanged ... */ };
        function showMultiResultModal(results) { /* ... unchanged ... */ };
        document.getElementById('multi-results-modal').onclick = (e) => { /* ... unchanged ... */ };
        function populateConfigSection(row) { /* ... unchanged ... */ };
        document.getElementById('calculate-btn').onclick = function() { /* ... fixed calculation logic ... */ };
        function displayResults(institutions, totalNeedOfActive, availableQty) { /* ... unchanged ... */ };
        document.getElementById('print-btn').onclick = () => window.print();
        document.getElementById('export-csv-btn').onclick = function() { /* ... unchanged ... */ };
        
    </script>
</body>
</html>
