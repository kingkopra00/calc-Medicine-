<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</title>
    <style>
        :root {
            --main-bg: #181b22;
            --panel-bg: #232633;
            --accent: #dc3545;
            --border: #353945;
            --text: #eee;
            --muted: #bbb;
        }
        body, main {
            background: var(--main-bg);
            color: var(--text);
            margin: 0;
            font-family: "Tajawal", "Segoe UI", Arial, sans-serif;
        }
        main {
            max-width: 700px;
            margin: auto;
            padding: 1rem 0.5rem 3rem;
        }
        h1, h2, h3 {
            text-align: center;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5em;
        }
        .dashboard {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin: 1em 0;
            text-align: center;
            font-size: 1em;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 1em;
        }
        .form-row label {
            flex: 1;
            min-width: 140px;
        }
        .form-row input, .form-row select {
            width: 100%;
            padding: 7px;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 6px;
            font-size: 1em;
        }
        .options-row {
            margin-bottom: 1em;
        }
        .options-row label {
            margin-left: 10px;
            font-size: 1em;
        }
        .search-row {
            margin-bottom: 1em;
        }
        .search-row input {
            width: 100%;
            padding: 7px;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 6px;
        }
        .institutions-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--panel-bg);
            font-size: 0.98em;
            margin-bottom: 1em;
        }
        .institutions-table th, .institutions-table td {
            border-bottom: 1px solid var(--border);
            padding: 7px 4px;
            text-align: center;
            vertical-align: middle;
            color: var(--text);
        }
        .institutions-table th {
            background: var(--panel-bg);
            font-weight: 600;
        }
        .institutions-table tr:hover td {
            background: #22242c;
        }
        .actions-cell button {
            background: var(--panel-bg);
            color: var(--accent);
            border: 1px solid var(--border);
            border-radius: 5px;
            margin: 0 2px;
            font-size: 1em;
            padding: 2px 10px;
        }
        .actions-cell button:active {
            background: var(--accent);
            color: var(--panel-bg);
        }
        textarea.note-input {
            min-height: 34px;
            resize: vertical;
            transition: min-height 0.2s;
            width: 95%;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 6px;
            font-size: 0.98em;
        }
        .input-small {
            width: 55px;
            font-size: 0.97em;
        }
        .input-error {
            border-color: var(--accent) !important;
            background: #281a1a !important;
        }
        .btn {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 7px;
            padding: 8px 18px;
            margin: 3px 2px;
            font-size: 1em;
            cursor: pointer;
        }
        .btn-accent {
            background: var(--accent);
            color: #fff;
            border: none;
        }
        .btn-block {
            width: 100%;
            margin: 7px 0 0;
        }
        /* Modal */
        .modal-bg {
            position: fixed;
            top:0; left:0; width:100vw; height:100vh;
            background: rgba(0,0,0,0.65);
            display:none; z-index:1000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--panel-bg);
            color: var(--text);
            border-radius: 8px;
            box-shadow: 0 4px 32px #0007;
            padding: 13px 14px;
            min-width: 220px;
            max-width: 330px;
            width: 95vw;
            margin: auto;
        }
        .modal-content h3 { font-size:1.1em;margin-bottom:0.7em; text-align:center;}
        .modal-content label {display:block; margin-bottom: 6px;}
        .modal-content input, .modal-content textarea {
            width: 100%; margin-top:3px; font-size:0.97em;
        }
        .modal-content .modal-btn-row {
            display: flex;
            gap: 7px;
            margin-top: 10px;
        }
        .modal-content .modal-btn-row button {
            flex: 1;
            font-size: 1em;
        }
        /* List Modal */
        #list-modal-content .list-item {
            padding:7px 0; border-bottom:1px solid var(--border);
            font-size: 0.97em;
        }
        #list-modal-content .list-add-btn {
            float:left;
            background: var(--panel-bg);
            color: var(--accent);
            border: 1px solid var(--border);
            padding: 2px 10px;
            border-radius: 5px;
            font-size: 1em;
        }
        @media (max-width: 520px) {
            main {padding:0.3rem 0.2rem 2rem;}
            .form-row label {min-width: 90px;}
            .modal-content, #list-modal-content {width:95vw; min-width:180px; max-width:330px; padding:9px 4px;}
            .dashboard {font-size:0.98em;}
            h1 {font-size:1.09em;}
            .institutions-table th, .institutions-table td {padding:4px 2px;}
        }
    </style>
</head>
<body>
    <main>
        <h1>ğŸ“‹ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</h1>
        <div class="dashboard" id="dashboard"></div>
        <form id="main-form" autocomplete="off" onsubmit="return false;">
            <div class="form-row">
                <label>
                    Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©
                    <input type="text" id="item-name" placeholder="Ù…Ø«Ø§Ù„: Amoxicillin 500mg">
                </label>
                <label>
                    Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©
                    <input type="text" id="available-qty" min="0" placeholder="0">
                </label>
            </div>
            <div class="options-row">
                <label>
                    <input type="checkbox" id="force-percent-distribution">
                    ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙƒÙ…ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… ØªØºØ·ÙŠØ© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                </label>
            </div>
            <div class="search-row">
                <input type="text" id="search-institutions" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¤Ø³Ø³Ø©...">
            </div>
        </form>
        <table class="institutions-table" id="institutions-table">
            <thead>
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</th>
                    <th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬</th>
                    <th>ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th>
                    <th>ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</th>
                    <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                    <th>Ø¹Ù…Ù„ÙŠØ§Øª</th>
                </tr>
            </thead>
            <tbody id="institutions-tbody"></tbody>
        </table>
        <div>
            <button class="btn secondary" id="add-institution-btn">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø³Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button class="btn secondary" id="list-btn">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª</button>
            <button class="btn btn-accent" id="reset-btn" type="button">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>
        <button class="btn btn-block" id="calculate-btn">ğŸ§® Ø§Ø­ØªØ³Ø§Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
        <section id="results-section" hidden>
            <h2>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</h2>
            <div id="summary-text"></div>
            <div id="results-table-container"></div>
            <div>
                <button class="btn secondary" id="export-csv">ğŸ’¾ ØªØµØ¯ÙŠØ± CSV</button>
                <button class="btn secondary" id="export-txt">ğŸ“„ ØªØµØ¯ÙŠØ± Ù†ØµÙŠ</button>
            </div>
        </section>
    </main>
    <footer style="text-align:center; color:#888; margin-top:1.5em;">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø©: ali mohammed hasan alnaji</footer>
    <!-- Add Institution Modal -->
    <div class="modal-bg" id="modal-bg">
        <div class="modal-content">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø³Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <form id="add-institute-form" autocomplete="off">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©
                    <input type="text" id="modal-institute-name" required>
                </label>
                <label>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬
                    <input type="text" id="modal-institute-need" required autocomplete="off">
                </label>
                <label>
                    <input type="checkbox" id="modal-show-min"> ØªÙØ¹ÙŠÙ„ ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰
                </label>
                <label id="modal-min-label" style="display:none;">ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰
                    <input type="text" id="modal-institute-min" style="font-size:0.89em;">
                </label>
                <label>
                    <input type="checkbox" id="modal-show-max"> ØªÙØ¹ÙŠÙ„ ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰
                </label>
                <label id="modal-max-label" style="display:none;">ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰
                    <input type="text" id="modal-institute-max" style="font-size:0.89em;">
                </label>
                <label>Ù…Ù„Ø§Ø­Ø¸Ø©
                    <textarea id="modal-institute-note" style="font-size:0.92em;min-height:30px;"></textarea>
                </label>
                <div class="modal-btn-row">
                    <button type="submit" class="btn secondary" id="modal-add-btn">Ø¥Ø¶Ø§ÙØ©</button>
                    <button type="button" class="btn btn-accent" id="modal-cancel-btn">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>
    <!-- List Modal -->
    <div class="modal-bg" id="list-modal-bg">
        <div class="modal-content" id="list-modal-content">
            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø§Ù„ØºÙŠØ± Ù…Ø¶Ø§ÙØ©</h3>
            <div id="list-list" style="max-height:220px;overflow-y:auto; margin-bottom:15px;"></div>
            <button class="btn btn-accent btn-block" id="list-modal-close">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
    <script>
        // Utility
        function normalizeNumber(str) {
            const arabicIndic = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
            const persianIndic = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
            let out = '';
            for (let i = 0; i < str.length; i++) {
                let ch = str[i];
                let idx = arabicIndic.indexOf(ch);
                if (idx !== -1) { out += String(idx); continue; }
                idx = persianIndic.indexOf(ch);
                if (idx !== -1) { out += String(idx); continue; }
                out += ch;
            }
            return out.replace(/[^\d.]/g, '');
        }
        let resultsData = [];
        let lastDistributedTotal = 0;
        const BANK_KEY = "institutions-bank";
        const DEFAULT_INSTITUTIONS = [
            { name: 'Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø­Ø³ÙŠÙ† Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ', need: '', min: '', max: '', note: '' },
            { name: 'Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù†Ø³Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ø§Ø·ÙØ§Ù„', need: '', min: '', max: '', note: '' },
            { name: 'Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„ÙˆØ±ÙƒØ§Ø¡', need: '', min: '', max: '', note: '' }
        ];
        // DOM references
        const institutionsTbody = document.getElementById('institutions-tbody');
        const dashboardDiv = document.getElementById('dashboard');
        const searchInstitutionsInput = document.getElementById('search-institutions');
        // Modal DOM
        const modalBg = document.getElementById('modal-bg');
        const addInstituteForm = document.getElementById('add-institute-form');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalAddBtn = document.getElementById('modal-add-btn');
        const modalInstituteName = document.getElementById('modal-institute-name');
        const modalInstituteNeed = document.getElementById('modal-institute-need');
        const modalShowMin = document.getElementById('modal-show-min');
        const modalMinLabel = document.getElementById('modal-min-label');
        const modalInstituteMin = document.getElementById('modal-institute-min');
        const modalShowMax = document.getElementById('modal-show-max');
        const modalMaxLabel = document.getElementById('modal-max-label');
        const modalInstituteMax = document.getElementById('modal-institute-max');
        const modalInstituteNote = document.getElementById('modal-institute-note');
        // List Modal DOM
        const listBtn = document.getElementById('list-btn');
        const listModalBg = document.getElementById('list-modal-bg');
        const listList = document.getElementById('list-list');
        const listModalClose = document.getElementById('list-modal-close');
        const exportCsvBtn = document.getElementById('export-csv');
        const exportTxtBtn = document.getElementById('export-txt');
        function updateDashboard() {
            let institutions = getInstitutionList();
            dashboardDiv.innerHTML = `<strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª:</strong> ${institutions.length}`;
        }
        // Table rendering
        function institutionRowTemplate(inst, idx) {
            return `<tr data-idx="${idx}">
                <td>
                    <span class="institution-name-text">${inst.name}</span>
                    <input type="text" class="institution-name-input" value="${inst.name}" hidden style="width:90px;">
                </td>
                <td>
                    <input type="text" class="need-input input-small" value="${inst.need}" autocomplete="off">
                </td>
                <td>
                    ${inst.min !== "" && inst.min != null ?
                        `<input type="text" class="min-input input-small" value="${inst.min}" autocomplete="off">` :
                        `<button class="show-min-btn" title="Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰" style="width:90%;font-size:0.86em;" data-idx="${idx}">+ Ø¥Ø¶Ø§ÙØ©</button>`
                    }
                </td>
                <td>
                    ${inst.max !== "" && inst.max != null ?
                        `<input type="text" class="max-input input-small" value="${inst.max}" autocomplete="off">` :
                        `<button class="show-max-btn" title="Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰" style="width:90%;font-size:0.86em;" data-idx="${idx}">+ Ø¥Ø¶Ø§ÙØ©</button>`
                    }
                </td>
                <td>
                    <textarea class="note-input" style="width:95%;">${inst.note || ''}</textarea>
                </td>
                <td class="actions-cell">
                    <button class="edit-btn" title="ØªØ¹Ø¯ÙŠÙ„">ğŸ“</button>
                    <button class="save-btn" hidden title="Ø­ÙØ¸">âœ…</button>
                    <button class="delete-btn" title="Ø­Ø°Ù">âœ•</button>
                    <button class="duplicate-btn" title="Ù†Ø³Ø®">ğŸ“‘</button>
                </td>
            </tr>`;
        }
        function renderInstitutionsTable() {
            let institutions = getInstitutionList();
            institutionsTbody.innerHTML = institutions.map(institutionRowTemplate).join('');
            Array.from(institutionsTbody.querySelectorAll('tr')).forEach((tr, idx) => {
                const nameSpan = tr.querySelector('.institution-name-text');
                const nameInput = tr.querySelector('.institution-name-input');
                const needInput = tr.querySelector('.need-input');
                const minInput = tr.querySelector('.min-input');
                const maxInput = tr.querySelector('.max-input');
                const noteInput = tr.querySelector('.note-input');
                const editBtn = tr.querySelector('.edit-btn');
                const saveBtn = tr.querySelector('.save-btn');
                const deleteBtn = tr.querySelector('.delete-btn');
                const duplicateBtn = tr.querySelector('.duplicate-btn');
                const showMinBtn = tr.querySelector('.show-min-btn');
                const showMaxBtn = tr.querySelector('.show-max-btn');
                editBtn.onclick = () => {
                    nameSpan.hidden = true;
                    nameInput.hidden = false;
                    editBtn.hidden = true;
                    saveBtn.hidden = false;
                    nameInput.focus();
                };
                saveBtn.onclick = () => {
                    const newName = nameInput.value.trim();
                    if (!newName || !isNaN(newName)) {
                        alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù†ØµØ§Ù‹ ÙˆØºÙŠØ± ÙØ§Ø±Øº.');
                        return;
                    }
                    nameSpan.textContent = newName;
                    nameSpan.hidden = false;
                    nameInput.hidden = true;
                    editBtn.hidden = false;
                    saveBtn.hidden = true;
                    saveInstitutionsFromTable();
                };
                deleteBtn.onclick = () => {
                    let institutions = getInstitutionList();
                    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù "${nameSpan.textContent}"ØŸ`)) {
                        institutions.splice(idx, 1);
                        saveInstitutionsList(institutions);
                        renderInstitutionsTable();
                        updateDashboard();
                    }
                };
                duplicateBtn.onclick = () => {
                    let institutions = getInstitutionList();
                    institutions.splice(idx + 1, 0, {...institutions[idx]});
                    saveInstitutionsList(institutions);
                    renderInstitutionsTable();
                    updateDashboard();
                };
                if (needInput) {
                    needInput.oninput = () => {
                        needInput.value = normalizeNumber(needInput.value);
                        if (needInput.value === "" || isNaN(needInput.value) || Number(needInput.value) < 0) {
                            needInput.classList.add('input-error');
                        } else {
                            needInput.classList.remove('input-error');
                        }
                        saveInstitutionsFromTable();
                    };
                }
                if (minInput) {
                    minInput.oninput = () => {
                        minInput.value = normalizeNumber(minInput.value);
                        saveInstitutionsFromTable();
                    };
                }
                if (maxInput) {
                    maxInput.oninput = () => {
                        maxInput.value = normalizeNumber(maxInput.value);
                        saveInstitutionsFromTable();
                    };
                }
                if (noteInput) {
                    noteInput.oninput = () => {
                        noteInput.style.height = Math.max(34, noteInput.scrollHeight) + 'px';
                        saveInstitutionsFromTable();
                    };
                    noteInput.onfocus = () => {
                        noteInput.style.height = Math.max(60, noteInput.scrollHeight) + 'px';
                    };
                }
                // "+ Ø¥Ø¶Ø§ÙØ©" buttons for min/max (set to 0 then show input)
                if (showMinBtn) {
                    showMinBtn.onclick = function() {
                        let institutions = getInstitutionList();
                        institutions[idx].min = "0";
                        saveInstitutionsList(institutions);
                        renderInstitutionsTable();
                        updateDashboard();
                    };
                }
                if (showMaxBtn) {
                    showMaxBtn.onclick = function() {
                        let institutions = getInstitutionList();
                        institutions[idx].max = "0";
                        saveInstitutionsList(institutions);
                        renderInstitutionsTable();
                        updateDashboard();
                    };
                }
            });
        }
        function saveInstitutionsFromTable() {
            const institutions = [];
            Array.from(institutionsTbody.querySelectorAll('tr')).forEach(tr => {
                institutions.push({
                    name: tr.querySelector('.institution-name-text').textContent,
                    need: tr.querySelector('.need-input') ? tr.querySelector('.need-input').value : "",
                    min: tr.querySelector('.min-input') ? tr.querySelector('.min-input').value : "",
                    max: tr.querySelector('.max-input') ? tr.querySelector('.max-input').value : "",
                    note: tr.querySelector('.note-input') ? tr.querySelector('.note-input').value : ""
                });
            });
            saveInstitutionsList(institutions);
            updateDashboard();
        }
        function saveInstitutionsList(list) {
            localStorage.setItem('institutions', JSON.stringify(list));
        }
        function getInstitutionList() {
            return JSON.parse(localStorage.getItem('institutions')) || DEFAULT_INSTITUTIONS.slice();
        }
        // Modal logic
        function openModal() {
            modalBg.style.display = "flex";
            addInstituteForm.reset();
            modalMinLabel.style.display = "none";
            modalMaxLabel.style.display = "none";
        }
        function closeModal() { modalBg.style.display = "none"; }
        modalShowMin.onchange = () => { modalMinLabel.style.display = modalShowMin.checked ? "block" : "none"; };
        modalShowMax.onchange = () => { modalMaxLabel.style.display = modalShowMax.checked ? "block" : "none"; };
        modalCancelBtn.onclick = closeModal;
        modalAddBtn.onclick = function(e) {
            e.preventDefault();
            addInstituteForm.requestSubmit();
        }
        addInstituteForm.onsubmit = function(e) {
            e.preventDefault();
            let name = modalInstituteName.value.trim();
            let need = normalizeNumber(modalInstituteNeed.value);
            let min = modalShowMin.checked ? normalizeNumber(modalInstituteMin.value) : "";
            let max = modalShowMax.checked ? normalizeNumber(modalInstituteMax.value) : "";
            let note = modalInstituteNote.value;
            if (!name || !need) { alert("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø© ÙˆØ§Ù„Ø§Ø­ØªÙŠØ§Ø¬."); return; }
            let institutions = getInstitutionList();
            institutions.push({name, need, min, max, note});
            saveInstitutionsList(institutions);
            let bank = getBankList();
            if (!bank.some(i => i.name === name)) {
                bank.push({name, need, min, max, note});
                saveBankList(bank);
            }
            closeModal();
            renderInstitutionsTable();
            updateDashboard();
        };
        document.getElementById('add-institution-btn').onclick = openModal;
        // List logic
        function getBankList() {
            return JSON.parse(localStorage.getItem(BANK_KEY)) || [];
        }
        function saveBankList(list) {
            localStorage.setItem(BANK_KEY, JSON.stringify(list));
        }
        function openListModal() {
            listModalBg.style.display = "flex";
            let bank = getBankList();
            let institutions = getInstitutionList();
            let notAdded = bank.filter(b => !institutions.some(i => i.name === b.name));
            if (notAdded.length === 0) {
                listList.innerHTML = "<p style='text-align:center;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¤Ø³Ø³Ø§Øª ØºÙŠØ± Ù…Ø¶Ø§ÙØ©.</p>";
            } else {
                listList.innerHTML = notAdded.map((i, idx) => `
                    <div class="list-item">
                        <strong>${i.name}</strong> | Ø§Ø­ØªÙŠØ§Ø¬: ${i.need}
                        ${i.min ? `| Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰: ${i.min}` : ""}
                        ${i.max ? `| Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${i.max}` : ""}
                        <button class="list-add-btn" data-idx="${idx}" style="float:left;">â• Ø¥Ø¶Ø§ÙØ©</button>
                        <br><span style="color:#bbb;font-size:0.98em;">${i.note||""}</span>
                    </div>
                `).join('');
                Array.from(listList.querySelectorAll(".list-add-btn")).forEach(btn => {
                    btn.onclick = function() {
                        let idx = Number(this.dataset.idx);
                        let bank = getBankList();
                        let institutions = getInstitutionList();
                        let inst = notAdded[idx];
                        institutions.push({...inst});
                        saveInstitutionsList(institutions);
                        renderInstitutionsTable();
                        updateDashboard();
                        openListModal(); // Refresh list
                    };
                });
            }
        }
        listBtn.onclick = openListModal;
        listModalClose.onclick = () => { listModalBg.style.display = "none"; };
        document.getElementById('reset-btn').onclick = () => {
            document.getElementById('item-name').value = '';
            document.getElementById('available-qty').value = '';
            document.getElementById('force-percent-distribution').checked = false;
            localStorage.removeItem('institutions');
            renderInstitutionsTable();
            updateDashboard();
            document.getElementById('results-section').hidden = true;
        };
        searchInstitutionsInput.oninput = function() {
            let term = this.value.trim();
            Array.from(institutionsTbody.querySelectorAll('tr')).forEach(tr => {
                let name = tr.querySelector('.institution-name-text').textContent;
                tr.style.display = (!term || name.includes(term)) ? "" : "none";
            });
        };
        function calculateDistribution() {
            let institutions = getInstitutionList();
            let availableQuantity = normalizeNumber(document.getElementById('available-qty').value);
            availableQuantity = parseInt(availableQuantity) || 0;
            let totalNeed = institutions.reduce((sum, i) => sum + parseInt(i.need||0), 0);
            let forcePercent = document.getElementById('force-percent-distribution').checked;
            let distributed = institutions.map(i => ({...i}));
            if (forcePercent) {
                distributed.forEach(i => {
                    i.distributedShare = Math.floor(((parseInt(i.need||0)/totalNeed)||0)*availableQuantity);
                });
                let remainder = availableQuantity - distributed.reduce((s,i)=>s+parseInt(i.distributedShare||0),0);
                distributed.sort((a,b)=>((parseInt(b.need||0)/totalNeed)-parseInt(a.need||0)/totalNeed));
                for(let j=0;j<remainder;j++) distributed[j%distributed.length].distributedShare += 1;
            } else if (availableQuantity >= totalNeed) {
                distributed.forEach(i => i.distributedShare = parseInt(i.need||0));
            } else {
                distributed.forEach(i => {
                    i.distributedShare = Math.floor(((parseInt(i.need||0)/totalNeed)||0)*availableQuantity);
                });
                let remainder = availableQuantity - distributed.reduce((s,i)=>s+parseInt(i.distributedShare||0),0);
                distributed.sort((a,b)=>((parseInt(b.need||0)/totalNeed)-parseInt(a.need||0)/totalNeed));
                for(let j=0;j<remainder;j++) distributed[j%distributed.length].distributedShare += 1;
            }
            distributed.forEach(i => {
                if(i.min && i.distributedShare < parseInt(i.min)) i.distributedShare = parseInt(i.min);
                if(i.max && i.distributedShare > parseInt(i.max)) i.distributedShare = parseInt(i.max);
            });
            resultsData = distributed.map(i=>({
                ...i,
                percentage: totalNeed===0?0:((parseInt(i.need||0)/totalNeed)*100),
                received:false
            }));
            lastDistributedTotal = distributed.reduce((s,i)=>s+parseInt(i.distributedShare||0),0);
            displayResultsAsTable(`<strong>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ÙˆØ²Ø¹Ø©:</strong> ${lastDistributedTotal}`);
        }
        document.getElementById('calculate-btn').onclick = calculateDistribution;
        function displayResultsAsTable(summary) {
            const container = document.getElementById('results-table-container');
            let tableHTML = `
                <table class="institutions-table">
                    <thead>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</th>
                            <th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬</th>
                            <th>ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th>
                            <th>ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</th>
                            <th>Ø§Ù„Ù†Ø³Ø¨Ø© (%)</th>
                            <th>Ø§Ù„Ø­ØµØ© Ø§Ù„Ù…ÙˆØ²Ø¹Ø©</th>
                            <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                            <th>ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…ØŸ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            let totalPercentage = 0, totalDistributed = 0;
            resultsData.forEach((row, idx) => {
                totalPercentage += row.percentage;
                totalDistributed += parseInt(row.distributedShare||0);
                tableHTML += `
                    <tr>
                        <td>${row.name}</td>
                        <td>${row.need}</td>
                        <td>${row.min||''}</td>
                        <td>${row.max||''}</td>
                        <td>${row.percentage.toFixed(2)}%</td>
                        <td><strong>${row.distributedShare}</strong></td>
                        <td>${row.note||''}</td>
                        <td><input type="checkbox"></td>
                    </tr>
                `;
            });
            tableHTML += `
                <tr style="background:#232633;">
                    <td><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</strong></td>
                    <td></td><td></td><td></td>
                    <td><strong>${totalPercentage.toFixed(2)}%</strong></td>
                    <td><strong>${totalDistributed}</strong></td>
                    <td></td><td></td>
                </tr>
            </tbody></table>`;
            container.innerHTML = tableHTML;
            document.getElementById('results-section').hidden = false;
        }

        // Export CSV
        exportCsvBtn.onclick = function() {
            if (!resultsData || !resultsData.length) {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.");
                return;
            }
            const itemName = document.getElementById('item-name').value.trim();
            const availableQty = normalizeNumber(document.getElementById('available-qty').value);
            const leftQty = availableQty - lastDistributedTotal;
            const header = [
                "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©",
                "Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©",
                "Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¨Ø§Ù‚ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ØµÙŠØµ",
                "Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©",
                "Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬",
                "ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰",
                "ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰",
                "Ø§Ù„Ù†Ø³Ø¨Ø© (%)",
                "Ø§Ù„Ø­ØµØ© Ø§Ù„Ù…ÙˆØ²Ø¹Ø©",
                "Ù…Ù„Ø§Ø­Ø¸Ø©"
            ];
            const rows = resultsData.map(row =>
                [
                    `"${itemName}"`,
                    `"${availableQty}"`,
                    `"${leftQty}"`,
                    `"${row.name}"`,
                    `"${row.need}"`,
                    `"${row.min||""}"`,
                    `"${row.max||""}"`,
                    `"${row.percentage.toFixed(2)}%"`,
                    `"${row.distributedShare}"`,
                    `"${row.note||""}"`
                ].join(',')
            );
            const csv = [header.join(','), ...rows].join('\r\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'distribution.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // Export TXT
        exportTxtBtn.onclick = function() {
            if (!resultsData || !resultsData.length) {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.");
                return;
            }
            const itemName = document.getElementById('item-name').value.trim();
            const availableQty = normalizeNumber(document.getElementById('available-qty').value);
            const leftQty = availableQty - lastDistributedTotal;
            const header = "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©\tØ§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©\tØ§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¨Ø§Ù‚ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ØµÙŠØµ\tØ§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©\tØ§Ù„Ø§Ø­ØªÙŠØ§Ø¬\tÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰\tÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰\tØ§Ù„Ù†Ø³Ø¨Ø© (%)\tØ§Ù„Ø­ØµØ© Ø§Ù„Ù…ÙˆØ²Ø¹Ø©\tÙ…Ù„Ø§Ø­Ø¸Ø©";
            const rows = resultsData.map(row =>
                [
                    itemName,
                    availableQty,
                    leftQty,
                    row.name,
                    row.need,
                    row.min||"",
                    row.max||"",
                    row.percentage.toFixed(2)+"%",
                    row.distributedShare,
                    row.note||""
                ].join('\t')
            );
            const txt = [header, ...rows].join('\r\n');
            const blob = new Blob([txt], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'distribution.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        renderInstitutionsTable();
        updateDashboard();
    </script>
</body>
</html>