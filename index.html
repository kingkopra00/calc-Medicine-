<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª - Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --main-bg: #1a1c23; --panel-bg: #252934; --accent: #007bff;
            --border: #3a3f4b; --text: #f0f0f0; --muted: #a0a0a0; --success: #28a745; --danger: #dc3545;
        }
        body { background: var(--main-bg); color: var(--text); margin: 0; font-family: "Tajawal", "Segoe UI", Arial, sans-serif; font-size: 16px; }
        main { max-width: 1000px; margin: 20px auto; padding: 1rem; }
        h1, h2, h3 { text-align: center; font-weight: 700; margin-bottom: 1em; }
        footer { text-align: center; margin-top: 2em; padding: 1em; color: var(--muted); border-top: 1px solid var(--border); }
        .section { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 1.5em; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 1em; align-items: end; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: var(--muted); }
        input, select { width: 100%; padding: 10px; background: var(--main-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .btn { background: var(--panel-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 10px 20px; font-size: 1em; cursor: pointer; width: 100%; transition: background-color 0.2s, border-color 0.2s; }
        .btn:hover { border-color: var(--accent); }
        .btn-primary { background: var(--accent); color: #fff; border: none; }
        .btn-danger { background-color: var(--danger); color: #fff; border: none; }
        #data-status { text-align: center; color: var(--accent); font-weight: bold; margin-bottom: 1em; min-height: 1.2em; }
        .search-wrapper { position: relative; }
        #suggestions-container {
            position: absolute; background-color: #2d3241; border: 1px solid var(--border);
            border-radius: 8px; width: 100%; z-index: 1000; max-height: 40vh; overflow-y: auto; top: 100%;
        }
        #suggestions-container.suggestions-above { top: auto; bottom: 100%; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #3a3f4b; }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1001; }
        .options-row { display: flex; align-items: center; gap: 10px; margin-top: 15px; padding: 12px; background: #2d3241; border-radius: 8px; }
        .results-summary { text-align: center; font-size: 1.1em; margin-bottom: 1em; background: #2d3241; padding: 10px; border-radius: 8px; }
        .results-table { width: 100%; border-collapse: collapse; font-size: 0.95em; margin-top: 1em; table-layout: fixed; }
        .results-table th, .results-table td { border-bottom: 1px solid var(--border); padding: 12px 8px; text-align: center; word-wrap: break-word; }
        .results-table tfoot td { font-weight: bold; border-top: 2px solid var(--accent); }
        #institutions-toggle-list { padding: 10px; border: 1px solid var(--border); border-radius: 8px; }
        #print-header { display: none; }
        
        @media print {
            body { background: #fff; color: #000; font-family: Arial, sans-serif; font-size: 10pt; }
            main, .section { margin: 0; padding: 0; border: none; box-shadow: none; background: #fff; }
            .no-print { display: none !important; }
            #print-header { display: block; text-align: center; margin-bottom: 2em; }
            #print-header h1 { font-size: 16pt; margin: 0; color: #000; }
            #print-header p { font-size: 12pt; margin: 5px 0; color: #000; }
            h1, h2 { display: none; }
            #results-table-container { margin-top: 1em; }
            .results-summary { background: #eee; border: 1px solid #ccc; color: #000; }
            .results-table { border: 1px solid #ccc; font-size: 9pt; }
            .results-table th, .results-table td { border: 1px solid #ccc; color: #000; }
            @page { size: A4; margin: 20mm; }
        }
    </style>
</head>
<body>
    <main>
        <h1 class="no-print">ğŸ“‹ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</h1>
        
        <div class="section no-print">
            <h2>Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø«</h2>
            <p id="data-status"></p>
            <div class="form-row">
                <div>
                    <label>Ø§Ø®ØªØ± Ø³Ù†Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ù„Ù„ØªØ­Ù…ÙŠÙ„ (ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)</label>
                    <select id="year-select">
                        <option value="">-- Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© --</option>
                    </select>
                </div>
                <div>
                    <button id="load-from-server-btn" class="btn btn-success">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±</button>
                </div>
                 <div><label style="visibility: hidden;">.</label><button id="clear-data-btn" class="btn btn-danger" hidden>ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</button></div>
            </div>
            <hr style="border-color: var(--border); margin: 2em 0;">
            <div class="form-row">
                <div><label>... Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</label><input type="file" id="excel-file-input" accept=".xlsx, .xls"></div>
                <div><button id="load-excel-btn" class="btn">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ ÙˆØªØ­Ø¯ÙŠØ«</button></div>
            </div>
            <hr style="border-color: var(--border); margin: 2em 0;">
            <div class="form-row">
                <div class="search-wrapper">
                    <label for="item-name-search">Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø§Ù„ÙƒÙˆØ¯</label>
                    <input type="text" id="item-name-search" placeholder="4 Ø£Ø­Ø±Ù ÙÙ…Ø§ ÙÙˆÙ‚ Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª">
                    <div id="suggestions-container"></div>
                </div>
                <div><label style="visibility: hidden;">.</label><button id="search-excel-btn" class="btn btn-primary">ğŸ” Ø¨Ø­Ø«</button></div>
            </div>
        </div>
        
        <div class="section no-print" id="config-section" hidden>
            </div>
        <div class="section" id="results-section" hidden>
            </div>
        <div class="modal-bg no-print" id="multi-results-modal">
            </div>
        <footer class="no-print">
            </footer>
    </main>
    
    <script>
        let excelData = { headers: [], rows: [] };
        let selectedRowData = { row: null, institutions: [] };
        let lastResultsData = [];
        const searchInput = document.getElementById('item-name-search');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const availableQtyInput = document.getElementById('available-qty-input');
        const packageSizeInput = document.getElementById('package-size-input');
        const forceDistCheck = document.getElementById('force-full-dist-check');

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim().toLowerCase();
            suggestionsContainer.innerHTML = '';
            if (query.length < 4 || excelData.rows.length === 0) return;
            const suggestions = excelData.rows.filter(row =>
                (row[0] && String(row[0]).toLowerCase().includes(query)) ||
                (row[1] && String(row[1]).toLowerCase().includes(query))
            ).slice(0, 15);
            if (suggestions.length === 0) return;
            suggestions.forEach(row => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = `${row[0] || ''} - ${row[1] || ''}`;
                item.onclick = () => {
                    searchInput.value = row[1];
                    suggestionsContainer.innerHTML = '';
                    document.getElementById('search-excel-btn').click();
                };
                suggestionsContainer.appendChild(item);
            });
            const inputRect = searchInput.getBoundingClientRect();
            const spaceBelow = window.innerHeight - inputRect.bottom;
            suggestionsContainer.classList.remove('suggestions-above');
            if (spaceBelow < suggestionsContainer.scrollHeight && inputRect.top > suggestionsContainer.scrollHeight) {
                suggestionsContainer.classList.add('suggestions-above');
            }
        });

        async function discoverAvailableYears() { /* ... Same as previous version ... */ }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocal();
            discoverAvailableYears();
            const savedForceSetting = localStorage.getItem('forceFullDistSetting');
            if (savedForceSetting === 'true') forceDistCheck.checked = true;
            forceDistCheck.onchange = (e) => localStorage.setItem('forceFullDistSetting', e.target.checked);
        });

        function normalizeAndCleanInput(value) { /* ... Same as previous version ... */ }
        availableQtyInput.addEventListener('input', (e) => e.target.value = normalizeAndCleanInput(e.target.value));
        packageSizeInput.addEventListener('input', (e) => e.target.value = normalizeAndCleanInput(e.target.value));
        function saveDataToLocal(data) { /* ... Same as previous version ... */ }
        function loadDataFromLocal() { /* ... Same as previous version ... */ }
        document.getElementById('clear-data-btn').onclick = () => { /* ... Same as previous version ... */ };
        document.getElementById('load-from-server-btn').onclick = function() { /* ... Same as previous version ... */ };
        function processExcelData(workbook) { /* ... Same as previous version ... */ }
        document.getElementById('load-excel-btn').onclick = function() { /* ... Same as previous version ... */ };
        document.addEventListener('click', (e) => { if (!e.target.closest('.search-wrapper')) { suggestionsContainer.innerHTML = ''; } });
        document.getElementById('search-excel-btn').onclick = function() { /* ... Same as previous version ... */ };
        function showMultiResultModal(results) { /* ... Same as previous version ... */ }
        document.getElementById('multi-results-modal').onclick = (e) => { /* ... Same as previous version ... */ };
        function populateConfigSection(row) { /* ... Same as previous version ... */ }
        
        // --- MODIFIED & FIXED: Calculation Logic ---
        document.getElementById('calculate-btn').onclick = function() {
            const availableQty = parseInt(availableQtyInput.value, 10);
            const packageSize = parseInt(packageSizeInput.value, 10) || 1;
            if (isNaN(availableQty)) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© Ù…ØªÙˆÙØ±Ø© ØµØ­ÙŠØ­Ø©."); return; }
            
            const activeInstitutions = selectedRowData.institutions.filter(inst => document.querySelector(`.institution-toggle[data-name="${inst.name}"]`).checked).map(inst => ({...inst})); 
            if (activeInstitutions.length === 0) { alert("ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ù…Ø¤Ø³Ø³Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ØªÙˆØ²ÙŠØ¹."); return; }
            
            const totalNeedOfActive = activeInstitutions.reduce((sum, i) => sum + i.need, 0);

            // Step 1: Calculate initial proportional shares
            activeInstitutions.forEach(inst => {
                let share = Math.floor((inst.need / totalNeedOfActive) * availableQty);
                // If not forcing distribution, cap the share at the institution's actual need
                if (!forceDistCheck.checked) {
                    share = Math.min(share, inst.need);
                }
                inst.share = share;
            });
            
            // Step 2: Distribute remainder from flooring using a safe while loop
            let distributedQty = activeInstitutions.reduce((sum, inst) => sum + inst.share, 0);
            let remainder = availableQty - distributedQty;
            
            // Sort by largest need to be fair
            activeInstitutions.sort((a, b) => b.need - a.need);
            
            let i = 0;
            while(remainder > 0) {
                const inst = activeInstitutions[i % activeInstitutions.length];
                // Only give a unit if there's room, or if we're forcing it
                if (forceDistCheck.checked || inst.share < inst.need) {
                    inst.share++;
                    remainder--;
                }
                i++;
                // Failsafe: if we've looped more times than there are institutions and nothing changed, break.
                if (i > activeInstitutions.length && remainder === (availableQty - activeInstitutions.reduce((sum, inst) => sum + inst.share, 0))) {
                    break;
                }
            }
            
            // Step 3 & 4 (Rounding and redistributing rounding remainder) remain the same
            activeInstitutions.forEach(inst => {
                inst.roundedShare = Math.floor(inst.share / packageSize) * packageSize;
            });

            if (packageSize > 1) {
                let totalRoundedDistributed = activeInstitutions.reduce((sum, inst) => sum + inst.roundedShare, 0);
                let roundingRemainder = availableQty - totalRoundedDistributed;
                
                while (roundingRemainder >= packageSize) {
                    let bestCandidate = null;
                    let maxLoss = -1;
                    activeInstitutions.forEach(inst => {
                        const roundingLoss = inst.share - inst.roundedShare;
                        if (roundingLoss > maxLoss && (forceDistCheck.checked || (inst.roundedShare + packageSize <= inst.need))) {
                           maxLoss = roundingLoss;
                           bestCandidate = inst;
                        }
                    });
                    if (bestCandidate) {
                        bestCandidate.roundedShare += packageSize;
                        roundingRemainder -= packageSize;
                    } else { break; }
                }
            }
            displayResults(activeInstitutions, totalNeedOfActive, availableQty);
        };

        function displayResults(institutions, totalNeedOfActive, availableQty) { /* ... Same as previous version ... */ }
        document.getElementById('print-btn').onclick = () => window.print();
        document.getElementById('export-csv-btn').onclick = function() { /* ... Same as previous version ... */ };
    </script>
</body>
</html>
