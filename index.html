<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --main-bg: #1a1c23; --panel-bg: #252934; --accent: #007bff;
            --border: #3a3f4b; --text: #f0f0f0; --muted: #a0a0a0; --success: #28a745; --danger: #dc3545;
        }
        body { background: var(--main-bg); color: var(--text); margin: 0; font-family: "Tajawal", "Segoe UI", Arial, sans-serif; font-size: 16px; }
        main { max-width: 900px; margin: 20px auto; padding: 1rem; }
        h1, h2, h3 { text-align: center; font-weight: 700; margin-bottom: 1em; }
        footer { text-align: center; margin-top: 2em; padding: 1em; color: var(--muted); border-top: 1px solid var(--border); }
        .section { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 1.5em; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 1em; align-items: end; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: var(--muted); }
        input[type="text"], input[type="file"] { width: 100%; padding: 10px; background: var(--main-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        input[readonly] { background: #2d3241; cursor: not-allowed; font-weight: bold; }
        .btn { background: var(--panel-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 10px 20px; font-size: 1em; cursor: pointer; width: 100%; transition: background-color 0.2s; }
        .btn:hover { border-color: var(--accent); }
        .btn-primary { background: var(--accent); color: #fff; border: none; }
        .btn-success { background: var(--success); color: #fff; border: none; }
        .results-table { width: 100%; border-collapse: collapse; font-size: 0.95em; margin-top: 1em; }
        .results-table th, .results-table td { border-bottom: 1px solid var(--border); padding: 12px 8px; text-align: center; }
        .results-table tfoot td { font-weight: bold; border-top: 2px solid var(--accent); }
        #institutions-toggle-list { padding: 10px; border: 1px solid var(--border); border-radius: 8px; }
        .toggle-table { width: 100%; }
        .options-row { display: flex; align-items: center; gap: 10px; margin-top: 15px; padding: 12px; background: #2d3241; border-radius: 8px; }
        .results-summary { text-align: center; font-size: 1.1em; margin-bottom: 1em; background: #2d3241; padding: 10px; border-radius: 8px; }
        /* --- NEW: Autocomplete styles --- */
        .search-wrapper { position: relative; }
        #suggestions-container { position: absolute; background-color: #2d3241; border: 1px solid var(--border); border-radius: 8px; width: 100%; top: 100%; z-index: 100; max-height: 300px; overflow-y: auto; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #3a3f4b; }
        /* Modal styles */
        .modal-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--panel-bg); padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .results-list-item { padding: 15px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s; }
        .results-list-item:hover { background-color: #3a3f4b; }
    </style>
</head>
<body>
    <main>
        <h1>ğŸ“‹ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</h1>
        
        <div class="section">
            <h2>Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ù…ÙŠÙ„ ÙˆØ¨Ø­Ø«</h2>
            <div class="form-row">
                <div><label for="excel-file-input">Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„</label><input type="file" id="excel-file-input" accept=".xlsx, .xls"></div>
                <div><button id="load-excel-btn" class="btn">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</button></div>
            </div>
            <div class="form-row">
                <div class="search-wrapper">
                    <label for="item-name-search">Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø§Ù„ÙƒÙˆØ¯ (4 Ø£Ø­Ø±Ù ÙÙ…Ø§ ÙÙˆÙ‚ Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª)</label>
                    <input type="text" id="item-name-search" placeholder="NATIONAL CODE or Item Name">
                    <div id="suggestions-container"></div>
                </div>
                <div><button id="search-excel-btn" class="btn btn-primary">ğŸ” Ø¨Ø­Ø«</button></div>
            </div>
        </div>

        <div class="section" id="config-section" hidden>
            <h2>Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹</h2>
            <div class="form-row">
                 <div><label for="item-name-display">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</label><input type="text" id="item-name-display" readonly></div>
                <div><label for="total-need-display">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø¯</label><input type="text" id="total-need-display" readonly></div>
            </div>
            <label>Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­ØµØ© Ù„Ù‡Ø§:</label>
            <div id="institutions-toggle-list"></div>
            <div class="options-row">
                <input type="checkbox" id="force-full-dist-check" style="width: 20px; height: 20px;">
                <label for="force-full-dist-check" style="margin: 0;">ØªÙˆØ²ÙŠØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© (Ø­ØªÙ‰ Ù„Ùˆ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬)</label>
            </div>
            <div class="form-row" style="margin-top: 20px;">
                 <div><label for="available-qty-input">âœ… Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ù„Ø¯ÙŠÙƒ</label><input type="text" id="available-qty-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ù‡Ù†Ø§"></div>
                 <div><button id="calculate-btn" class="btn btn-success">ğŸ§® Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø­ØµØµ</button></div>
            </div>
        </div>

        <div class="section" id="results-section" hidden>
            <h2>Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
            <div id="results-table-container"></div>
            <button id="export-csv-btn" class="btn" style="margin-top: 20px; background-color: #17a2b8; border:none;">ğŸ’¾ ØªØµØ¯ÙŠØ± CSV</button>
        </div>
    </main>
    
    <div class="modal-bg" id="multi-results-modal">
        <div class="modal-content">
            <h3>ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¯Ø© Ù†ØªØ§Ø¦Ø¬ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</h3>
            <div id="results-list"></div>
        </div>
    </div>

    <footer>
        <p>Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø­Ø³Ù†</p>
        <p>Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„Ø© - Ø¯Ø§Ø¦Ø±Ø© ØµØ­Ø© Ø§Ù„Ù…Ø«Ù†Ù‰</p>
    </footer>

    <script>
        let excelData = { headers: [], rows: [] };
        let selectedRowData = { row: null, institutions: [] };
        let lastResultsData = [];

        const searchInput = document.getElementById('item-name-search');
        const suggestionsContainer = document.getElementById('suggestions-container');

        document.getElementById('load-excel-btn').onclick = function() {
            const fileInput = document.getElementById('excel-file-input');
            if (!fileInput.files.length) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¥ÙƒØ³Ù„."); return; }
            const reader = new FileReader();
            reader.onload = e => {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                if (jsonData.length > 1) {
                    excelData = { headers: jsonData[0], rows: jsonData.slice(1) };
                    alert(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ (${excelData.rows.length} ØµÙ).`);
                } else { alert("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº."); }
            };
            reader.readAsBinaryString(fileInput.files[0]);
        };
        
        // --- NEW: Autocomplete logic ---
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim().toLowerCase();
            suggestionsContainer.innerHTML = '';
            if (query.length < 4 || excelData.rows.length === 0) {
                return;
            }

            const suggestions = excelData.rows.filter(row =>
                (row[0] && String(row[0]).toLowerCase().includes(query)) ||
                (row[1] && String(row[1]).toLowerCase().includes(query))
            ).slice(0, 10); // Limit to 10 suggestions

            suggestions.forEach(row => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = `${row[0] || ''} - ${row[1] || ''}`;
                item.onclick = () => {
                    searchInput.value = row[1]; // Put item name in search box
                    suggestionsContainer.innerHTML = ''; // Hide suggestions
                    document.getElementById('search-excel-btn').click(); // Trigger search
                };
                suggestionsContainer.appendChild(item);
            });
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-wrapper')) {
                suggestionsContainer.innerHTML = '';
            }
        });

        document.getElementById('search-excel-btn').onclick = function() {
            const query = searchInput.value.trim().toLowerCase();
            suggestionsContainer.innerHTML = ''; // Hide suggestions on search
            if (!query) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ù„Ù„Ø¨Ø­Ø«."); return; }
            if (excelData.rows.length === 0) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹."); return; }
            const results = excelData.rows.filter(row =>
                (row[0] && String(row[0]).toLowerCase().includes(query)) ||
                (row[1] && String(row[1]).toLowerCase().includes(query))
            );
            if (results.length === 0) { alert(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«.`); }
            else if (results.length === 1) { populateConfigSection(results[0]); }
            else { showMultiResultModal(results); }
        };
        
        function showMultiResultModal(results) {
            const modal = document.getElementById('multi-results-modal');
            const listContainer = document.getElementById('results-list');
            listContainer.innerHTML = '';
            results.forEach(row => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'results-list-item';
                itemDiv.innerHTML = `<strong>${row[0] || 'N/A'}</strong><br>${row[1] || 'N/A'}`;
                itemDiv.onclick = () => { populateConfigSection(row); modal.style.display = 'none'; };
                listContainer.appendChild(itemDiv);
            });
            modal.style.display = 'flex';
        }
        
        document.getElementById('multi-results-modal').onclick = (e) => { if (e.target === e.currentTarget) e.currentTarget.style.display = 'none'; };

        function populateConfigSection(row) {
            document.getElementById('config-section').hidden = false;
            document.getElementById('results-section').hidden = true;
            document.getElementById('available-qty-input').value = '';
            document.getElementById('item-name-display').value = row[1] || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            document.getElementById('total-need-display').value = (parseInt(row[6], 10) || 0).toLocaleString();
            const institutions = [];
            const keywords = ["Ù…Ø³ØªØ´ÙÙ‰", "Ù‚Ø·Ø§Ø¹", "Ù…Ø±ÙƒØ²", "ØªØ£Ù‡ÙŠÙ„", "Ø§Ø³Ù†Ø§Ù†", "Ø­Ø³Ø§Ø³ÙŠØ©", "ØµØ¯Ø±ÙŠØ©", "Ø³ÙƒØ±ÙŠ"];
            excelData.headers.forEach((header, index) => {
                if (header && header.includes("Ø§Ø­ØªÙŠØ§Ø¬") && !header.includes("Ù…ØµØ±ÙˆÙ")) {
                    const containsKeyword = keywords.some(k => header.includes(k));
                    if (containsKeyword) {
                        const institutionName = header.replace("Ø§Ø­ØªÙŠØ§Ø¬", "").replace(/2025/g, "").trim();
                        const needValue = parseInt(row[index], 10) || 0;
                        if (institutionName && needValue > 0) institutions.push({ name: institutionName, need: needValue });
                    }
                }
            });
            selectedRowData = { row: row, institutions: institutions };
            const toggleList = document.getElementById('institutions-toggle-list');
            let tableHTML = `<table class="toggle-table"><thead><tr>
                <th><input type="checkbox" id="toggle-all-institutions" checked></th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</th><th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬</th>
                </tr></thead><tbody>`;
            institutions.forEach(inst => { tableHTML += `<tr><td><input type="checkbox" class="institution-toggle" data-name="${inst.name}" checked></td><td>${inst.name}</td><td>${inst.need.toLocaleString()}</td></tr>`; });
            toggleList.innerHTML = tableHTML + `</tbody></table>`;
            document.getElementById('toggle-all-institutions').onchange = (e) => document.querySelectorAll('.institution-toggle').forEach(cb => cb.checked = e.target.checked);
        }
        
        document.getElementById('calculate-btn').onclick = function() {
            const availableQty = parseInt(document.getElementById('available-qty-input').value.replace(/,/g, ''), 10);
            if (isNaN(availableQty) || availableQty < 0) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© Ù…ØªÙˆÙØ±Ø© ØµØ­ÙŠØ­Ø©."); return; }
            const forceFullDistribution = document.getElementById('force-full-dist-check').checked;
            const activeInstitutions = selectedRowData.institutions.filter(inst => document.querySelector(`.institution-toggle[data-name="${inst.name}"]`).checked).map(inst => ({...inst})); 
            if (activeInstitutions.length === 0) { alert("ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ù…Ø¤Ø³Ø³Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ØªÙˆØ²ÙŠØ¹."); return; }
            const totalNeedOfActive = activeInstitutions.reduce((sum, i) => sum + i.need, 0);
            let distributedQty = 0;
            activeInstitutions.forEach(inst => {
                let share = Math.floor((inst.need / totalNeedOfActive) * availableQty);
                if (!forceFullDistribution) { share = Math.min(share, inst.need); }
                inst.share = share;
                distributedQty += share;
            });
            let remainder = availableQty - distributedQty;
            activeInstitutions.sort((a, b) => (b.need / totalNeedOfActive) - (a.need / totalNeedOfActive));
            for (let i = 0; i < remainder; i++) {
                let inst = activeInstitutions[i % activeInstitutions.length];
                if (forceFullDistribution || inst.share < inst.need) { inst.share++; } else { remainder++; }
            }
            displayResults(activeInstitutions, totalNeedOfActive, availableQty);
        };

        // --- MODIFICATION: Updated displayResults to remove surplus column ---
        function displayResults(institutions, totalNeedOfActive, availableQty) {
            lastResultsData = institutions;
            const container = document.getElementById('results-table-container');
            const totalDistributed = institutions.reduce((sum, inst) => sum + inst.share, 0);
            const overallCoveragePercentage = totalNeedOfActive > 0 ? ((totalDistributed / totalNeedOfActive) * 100).toFixed(1) : 0;
            const summaryHTML = `<div class="results-summary"><span><strong>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©:</strong> ${availableQty.toLocaleString()}</span> | <span><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ²Ø¹:</strong> ${totalDistributed.toLocaleString()}</span> | <span><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ø¯ÙŠÙƒ:</strong> ${(availableQty - totalDistributed).toLocaleString()}</span></div>`;
            let tableHTML = summaryHTML + `<table class="results-table"><thead><tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</th><th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø³Ù†ÙˆÙŠ</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ÙˆØ²Ø¹Ø©</th><th>Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬</th>
                </tr></thead><tbody>`;
            institutions.forEach(inst => {
                const percentageOfTotalNeed = totalNeedOfActive > 0 ? ((inst.need / totalNeedOfActive) * 100).toFixed(1) : 0;
                tableHTML += `<tr>
                    <td>${inst.name}</td><td>${inst.need.toLocaleString()}</td>
                    <td style="font-weight:bold; color: var(--success);">${inst.share.toLocaleString()}</td>
                    <td>${percentageOfTotalNeed}%</td></tr>`;
            });
            tableHTML += `</tbody><tfoot><tr>
                <td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</td><td>${totalNeedOfActive.toLocaleString()}</td>
                <td>${totalDistributed.toLocaleString()}</td>
                <td>${overallCoveragePercentage}% (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØºØ·ÙŠØ©)</td></tr></tfoot></table>`;
            container.innerHTML = tableHTML;
            document.getElementById('results-section').hidden = false;
        }

        // --- MODIFICATION: Updated export to remove surplus column ---
        document.getElementById('export-csv-btn').onclick = function() {
            if (lastResultsData.length === 0) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§."); return; }
            const itemName = document.getElementById('item-name-display').value;
            let csvContent = "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©,Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©,Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø³Ù†ÙˆÙŠ,Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ÙˆØ²Ø¹Ø©,Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬\n";
            const totalNeedOfActive = lastResultsData.reduce((sum, i) => sum + i.need, 0);
            lastResultsData.forEach(inst => {
                const percentageOfTotalNeed = totalNeedOfActive > 0 ? ((inst.need / totalNeedOfActive) * 100).toFixed(1) : "0.0";
                const row = `"${itemName}","${inst.name}",${inst.need},${inst.share},"${percentageOfTotalNeed}%"`;
                csvContent += row + "\n";
            });
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const safeItemName = itemName.replace(/[^a-z0-9]/gi, '_');
            link.setAttribute("download", `distribution_${safeItemName}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
    </script>
</body>
</html>
