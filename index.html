<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª - Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --main-bg: #1a1c23; --panel-bg: #252934; --accent: #007bff;
            --border: #3a3f4b; --text: #f0f0f0; --muted: #a0a0a0; --success: #28a745; --danger: #dc3545;
        }
        body { background: var(--main-bg); color: var(--text); margin: 0; font-family: "Tajawal", "Segoe UI", Arial, sans-serif; font-size: 16px; }
        main { max-width: 1000px; margin: 20px auto; padding: 1rem; }
        h1, h2, h3 { text-align: center; font-weight: 700; margin-bottom: 1em; }
        footer { text-align: center; margin-top: 2em; padding: 1em; color: var(--muted); border-top: 1px solid var(--border); }
        .section { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 1.5em; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 1em; align-items: end; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: var(--muted); }
        input, select { width: 100%; padding: 10px; background: var(--main-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .btn { background: var(--panel-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 10px 20px; font-size: 1em; cursor: pointer; width: 100%; transition: background-color 0.2s, border-color 0.2s; }
        .btn:hover { border-color: var(--accent); }
        .btn-primary { background: var(--accent); color: #fff; border: none; }
        .btn-success { background: var(--success); color: #fff; border: none; } /* Added btn-success */
        .btn-danger { background-color: var(--danger); color: #fff; border: none; }
        #data-status { text-align: center; color: var(--accent); font-weight: bold; margin-bottom: 1em; min-height: 1.2em; }
        .search-wrapper { position: relative; }
        #suggestions-container {
            position: absolute; background-color: #2d3241; border: 1px solid var(--border);
            border-radius: 8px; width: 100%; z-index: 1000; max-height: 40vh; overflow-y: auto; top: 100%;
        }
        #suggestions-container.suggestions-above { top: auto; bottom: 100%; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #3a3f4b; }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1001; }
        .modal-content { background: var(--panel-bg); padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .options-row { display: flex; align-items: center; gap: 10px; margin-top: 15px; padding: 12px; background: #2d3241; border-radius: 8px; }
        .results-summary { text-align: center; font-size: 1.1em; margin-bottom: 1em; background: #2d3241; padding: 10px; border-radius: 8px; }
        .results-table { width: 100%; border-collapse: collapse; font-size: 0.95em; margin-top: 1em; table-layout: fixed; }
        .results-table th, .results-table td { border-bottom: 1px solid var(--border); padding: 12px 8px; text-align: center; word-wrap: break-word; }
        .results-table tfoot td { font-weight: bold; border-top: 2px solid var(--accent); }
        #institutions-toggle-list { padding: 10px; border: 1px solid var(--border); border-radius: 8px; }
        #print-header { display: none; }
        
        @media print {
            body { background: #fff; color: #000; font-family: Arial, sans-serif; font-size: 10pt; }
            main, .section { margin: 0; padding: 0; border: none; box-shadow: none; background: #fff; }
            .no-print { display: none !important; }
            #print-header { display: block; text-align: center; margin-bottom: 2em; }
            #print-header h1 { font-size: 16pt; margin: 0; color: #000; }
            #print-header p { font-size: 12pt; margin: 5px 0; color: #000; }
            h1, h2 { display: none; }
            #results-table-container { margin-top: 1em; }
            .results-summary { background: #eee; border: 1px solid #ccc; color: #000; }
            .results-table { border: 1px solid #ccc; font-size: 9pt; }
            .results-table th, .results-table td { border: 1px solid #ccc; color: #000; }
            @page { size: A4; margin: 20mm; }
        }
    </style>
</head>
<body>
    <main>
        <h1 class="no-print">ğŸ“‹ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</h1>
        
        <div class="section no-print">
            <h2>Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø«</h2>
            <p id="data-status"></p>
            <div class="form-row">
                <div>
                    <label>Ø§Ø®ØªØ± Ø³Ù†Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ù„Ù„ØªØ­Ù…ÙŠÙ„ (ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)</label>
                    <select id="year-select"><option value="">-- Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«... --</option></select>
                </div>
                <div><button id="load-from-server-btn" class="btn btn-success">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±</button></div>
                 <div><label style="visibility: hidden;">.</label><button id="clear-data-btn" class="btn btn-danger" hidden>ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</button></div>
            </div>
            <hr style="border-color: var(--border); margin: 2em 0;">
            <div class="form-row">
                <div><label>... Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</label><input type="file" id="excel-file-input" accept=".xlsx, .xls"></div>
                <div><button id="load-excel-btn" class="btn">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ ÙˆØªØ­Ø¯ÙŠØ«</button></div>
            </div>
            <hr style="border-color: var(--border); margin: 2em 0;">
            <div class="form-row">
                <div class="search-wrapper">
                    <label for="item-name-search">Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø§Ù„ÙƒÙˆØ¯</label>
                    <input type="text" id="item-name-search" placeholder="4 Ø£Ø­Ø±Ù ÙÙ…Ø§ ÙÙˆÙ‚ Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª">
                    <div id="suggestions-container"></div>
                </div>
                <div><label style="visibility: hidden;">.</label><button id="search-excel-btn" class="btn btn-primary">ğŸ” Ø¨Ø­Ø«</button></div>
            </div>
        </div>
        
        <div class="section no-print" id="config-section" hidden>
            <h2>Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹</h2>
            <button id="reset-btn" class="btn btn-danger" style="margin-bottom: 1em;">Ù…Ø³Ø­ ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
            <div class="form-row">
                 <div><label for="item-name-display">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</label><input type="text" id="item-name-display" readonly></div>
                <div><label for="total-need-display">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø¯</label><input type="text" id="total-need-display" readonly></div>
            </div>
            <label>Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­ØµØ© Ù„Ù‡Ø§:</label>
            <div id="institutions-toggle-list"></div>
            <div class="options-row">
                <input type="checkbox" id="force-full-dist-check" style="width: 20px; height: 20px;">
                <label for="force-full-dist-check" style="margin: 0;">ØªÙˆØ²ÙŠØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© (Ø­ØªÙ‰ Ù„Ùˆ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬)</label>
            </div>
            <div class="form-row" style="margin-top: 20px;">
                 <div>
                    <label for="available-qty-input">âœ… Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ù„Ø¯ÙŠÙƒ</label>
                    <input type="text" id="available-qty-input" placeholder="Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·" inputmode="numeric">
                </div>
                <div>
                    <label for="package-size-input">ğŸ“¦ Ø­Ø¬Ù… Ø§Ù„Ø¹Ø¨ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" id="package-size-input" placeholder="Ù…Ø«Ø§Ù„: 30" inputmode="numeric">
                </div>
                 <div><button id="calculate-btn" class="btn btn-success">ğŸ§® Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø­ØµØµ</button></div>
            </div>
        </div>

        <div class="section" id="results-section" hidden>
            <div id="print-header">
                <h1 id="print-item-name"></h1>
                <p id="print-item-code"></p>
            </div>
            <h2 class="no-print">Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
            <div id="results-table-container"></div>
            <div class="form-row no-print" style="margin-top: 20px;">
                <button id="print-btn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                <button id="export-csv-btn" class="btn" style="background-color: #17a2b8; border:none;">ğŸ’¾ ØªØµØ¯ÙŠØ± CSV</button>
            </div>
        </div>
    </main>
    
    <div class="modal-bg no-print" id="multi-results-modal">
        <div class="modal-content">
            <h3>ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø¯Ø© Ù†ØªØ§Ø¦Ø¬ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</h3>
            <div id="results-list"></div>
        </div>
    </div>

    <footer class="no-print">
        <p>Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø­Ø³Ù†</p>
        <p>Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„Ø© - Ø¯Ø§Ø¦Ø±Ø© ØµØ­Ø© Ø§Ù„Ù…Ø«Ù†Ù‰</p>
    </footer>

    <script>
        let excelData = { headers: [], rows: [] };
        let selectedRowData = { row: null, institutions: [] };
        let lastResultsData = [];
        const searchInput = document.getElementById('item-name-search');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const availableQtyInput = document.getElementById('available-qty-input');
        const packageSizeInput = document.getElementById('package-size-input');
        const forceDistCheck = document.getElementById('force-full-dist-check');
        const configSection = document.getElementById('config-section');
        const resultsSection = document.getElementById('results-section');

        async function discoverAvailableYears() {
            const yearSelect = document.getElementById('year-select');
            const apiUrl = 'https://api.github.com/repos/kingkopra00/calc-Medicine-/contents/';
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub.');
                const files = await response.json();
                const yearRegex = /^data(\d{4})\.xlsx$/;
                const availableYears = [];
                for (const file of files) {
                    const match = file.name.match(yearRegex);
                    if (match) availableYears.push(match[1]);
                }
                yearSelect.innerHTML = '';
                if (availableYears.length > 0) {
                    availableYears.sort((a, b) => b - a);
                    yearSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø© --</option>';
                    availableYears.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = `Ø§Ø­ØªÙŠØ§Ø¬ ${year}`;
                        yearSelect.appendChild(option);
                    });
                } else { yearSelect.innerHTML = '<option value="">-- Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª --</option>'; }
            } catch (error) {
                console.error("Discovery Error:", error);
                yearSelect.innerHTML = '<option value="">-- Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„ÙØ§Øª --</option>';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocal();
            discoverAvailableYears();
            const savedForceSetting = localStorage.getItem('forceFullDistSetting');
            if (savedForceSetting === 'true') forceDistCheck.checked = true;
            forceDistCheck.onchange = (e) => localStorage.setItem('forceFullDistSetting', e.target.checked);
        });

        function normalizeAndCleanInput(value) {
            const arabicNumerals = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            let str = String(value);
            for (let i = 0; i < 10; i++) str = str.replace(new RegExp(arabicNumerals[i], 'g'), i);
            return str.replace(/[^0-9]/g, '');
        }
        
        availableQtyInput.addEventListener('input', (e) => e.target.value = normalizeAndCleanInput(e.target.value));
        packageSizeInput.addEventListener('input', (e) => e.target.value = normalizeAndCleanInput(e.target.value));

        function saveDataToLocal(data) { try { localStorage.setItem('savedDistributionData', JSON.stringify(data)); } catch (e) { alert("Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."); } }

        function loadDataFromLocal() {
            const savedData = localStorage.getItem('savedDistributionData');
            const statusEl = document.getElementById('data-status');
            const clearBtn = document.getElementById('clear-data-btn');
            if (savedData) {
                try {
                    excelData = JSON.parse(savedData);
                    statusEl.textContent = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${excelData.rows.length} ØµÙ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.`;
                    clearBtn.hidden = false;
                } catch (e) { statusEl.textContent = "âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©."; localStorage.removeItem('savedDistributionData'); }
            } else { statusEl.textContent = "ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ù„Ù„Ø¨Ø¯Ø¡."; }
        }

        document.getElementById('clear-data-btn').onclick = () => { if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) { localStorage.removeItem('savedDistributionData'); location.reload(); } };
        
        document.getElementById('load-from-server-btn').onclick = function() {
            const selectedYear = document.getElementById('year-select').value;
            if (!selectedYear) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø³Ù†Ø©.'); return; }
            const excelFileUrl = `https://raw.githubusercontent.com/kingkopra00/calc-Medicine-/main/data${selectedYear}.xlsx`;
            const statusEl = document.getElementById('data-status');
            statusEl.textContent = `Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ù†Ø© ${selectedYear}...`;
            fetch(excelFileUrl)
                .then(response => { if (!response.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù.'); return response.arrayBuffer(); })
                .then(arrayBuffer => {
                    const workbook = XLSX.read(new Uint8Array(arrayBuffer), {type: 'array'});
                    processExcelData(workbook);
                })
                .catch(error => { alert(`Ø®Ø·Ø£: ${error.message}`); statusEl.textContent = 'âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.'; });
        };
        
        function processExcelData(workbook) {
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            if (jsonData.length > 1) {
                excelData = { headers: jsonData[0] || [], rows: jsonData.slice(1) };
                saveDataToLocal(excelData);
                alert(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.`);
                loadDataFromLocal();
            } else { alert("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº."); }
        }

        document.getElementById('load-excel-btn').onclick = function() {
            const fileInput = document.getElementById('excel-file-input');
            if (!fileInput.files.length) { alert("Ø§Ø®ØªØ± Ù…Ù„Ù Ø¥ÙƒØ³Ù„."); return; }
            const reader = new FileReader();
            reader.onload = e => {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                processExcelData(workbook);
            };
            reader.readAsBinaryString(fileInput.files[0]);
        };
        
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim().toLowerCase();
            suggestionsContainer.innerHTML = '';
            if (query.length < 4 || excelData.rows.length === 0) return;
            const suggestions = excelData.rows.filter(row => (row[0] && String(row[0]).toLowerCase().includes(query)) || (row[1] && String(row[1]).toLowerCase().includes(query))).slice(0, 15);
            if (suggestions.length === 0) return;
            
            suggestions.forEach(row => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = `${row[0] || ''} - ${row[1] || ''}`;
                item.onclick = () => {
                    suggestionsContainer.innerHTML = '';
                    populateConfigSection(row); // MODIFIED: Direct selection
                };
                suggestionsContainer.appendChild(item);
            });

            setTimeout(() => {
                const inputRect = searchInput.getBoundingClientRect();
                const spaceBelow = window.innerHeight - inputRect.bottom;
                suggestionsContainer.classList.remove('suggestions-above');
                if (spaceBelow < suggestionsContainer.scrollHeight && inputRect.top > suggestionsContainer.scrollHeight) {
                    suggestionsContainer.classList.add('suggestions-above');
                }
            }, 0);
        });

        document.addEventListener('click', (e) => { if (!e.target.closest('.search-wrapper')) { suggestionsContainer.innerHTML = ''; } });

        document.getElementById('search-excel-btn').onclick = function() {
            const query = searchInput.value.trim().toLowerCase();
            suggestionsContainer.innerHTML = '';
            if (!query) { alert("Ø£Ø¯Ø®Ù„ Ù†Øµ Ù„Ù„Ø¨Ø­Ø«."); return; }
            if (excelData.rows.length === 0) { alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."); return; }
            const results = excelData.rows.filter(row => (row && row[1] && String(row[1]).toLowerCase().includes(query)) || (row && row[0] && String(row[0]).toLowerCase().includes(query)));
            if (results.length === 0) { alert(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.`); }
            else if (results.length === 1) { populateConfigSection(results[0]); }
            else { showMultiResultModal(results); }
        };
        
        function showMultiResultModal(results) {
            const modal = document.getElementById('multi-results-modal');
            const listContainer = document.getElementById('results-list');
            listContainer.innerHTML = '';
            results.forEach(row => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'results-list-item';
                itemDiv.innerHTML = `<strong>${row[0] || 'N/A'}</strong><br>${row[1] || 'N/A'}`;
                itemDiv.onclick = () => { populateConfigSection(row); modal.style.display = 'none'; };
                listContainer.appendChild(itemDiv);
            });
            modal.style.display = 'flex';
        }
        
        document.getElementById('multi-results-modal').onclick = (e) => { if (e.target === e.currentTarget) { e.currentTarget.style.display = 'none'; } };
        
        document.getElementById('reset-btn').onclick = function() {
            searchInput.value = '';
            availableQtyInput.value = '';
            packageSizeInput.value = '';
            configSection.hidden = true;
            resultsSection.hidden = true;
        };

        function populateConfigSection(row) {
            configSection.hidden = false;
            resultsSection.hidden = true;
            availableQtyInput.value = '';
            packageSizeInput.value = '';
            searchInput.value = row[1] || ''; // Also populate the search bar for clarity
            document.getElementById('item-name-display').value = row[1] || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            document.getElementById('total-need-display').value = (parseInt(row[6], 10) || 0).toLocaleString();
            const institutions = [];
            const keywords = ["Ù…Ø³ØªØ´ÙÙ‰", "Ù‚Ø·Ø§Ø¹", "Ù…Ø±ÙƒØ²", "ØªØ£Ù‡ÙŠÙ„", "Ø§Ø³Ù†Ø§Ù†", "Ø­Ø³Ø§Ø³ÙŠØ©", "ØµØ¯Ø±ÙŠØ©", "Ø³ÙƒØ±ÙŠ"];
            excelData.headers.forEach((header, index) => {
                if (header && header.includes("Ø§Ø­ØªÙŠØ§Ø¬") && !header.includes("Ù…ØµØ±ÙˆÙ")) {
                    const containsKeyword = keywords.some(k => header.toLowerCase().includes(k));
                    if (containsKeyword) {
                        const institutionName = header.replace(/Ø§Ø­ØªÙŠØ§Ø¬/i, "").replace(/202\d/g, "").trim();
                        const needValue = parseInt(row[index], 10) || 0;
                        if (institutionName && needValue > 0) institutions.push({ name: institutionName, need: needValue });
                    }
                }
            });
            selectedRowData = { row: row, institutions: institutions };
            const toggleList = document.getElementById('institutions-toggle-list');
            let tableHTML = `<table class="toggle-table"><thead><tr><th><input type="checkbox" id="toggle-all-institutions" checked></th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</th><th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬</th></tr></thead><tbody>`;
            institutions.forEach(inst => { tableHTML += `<tr><td><input type="checkbox" class="institution-toggle" data-name="${inst.name}" checked></td><td>${inst.name}</td><td>${inst.need.toLocaleString()}</td></tr>`; });
            toggleList.innerHTML = tableHTML + `</tbody></table>`;
            document.getElementById('toggle-all-institutions').onchange = (e) => document.querySelectorAll('.institution-toggle').forEach(cb => cb.checked = e.target.checked);
        }
        
        document.getElementById('calculate-btn').onclick = function() {
            const availableQty = parseInt(availableQtyInput.value, 10);
            const packageSize = parseInt(packageSizeInput.value, 10) || 1;
            if (isNaN(availableQty) || availableQty < 0) { alert("Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©."); return; }
            const activeInstitutions = selectedRowData.institutions.filter(inst => document.querySelector(`.institution-toggle[data-name="${inst.name}"]`).checked).map(inst => ({...inst})); 
            if (activeInstitutions.length === 0) { alert("Ø§Ø®ØªØ± Ù…Ø¤Ø³Ø³Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; }
            const totalNeedOfActive = activeInstitutions.reduce((sum, i) => sum + i.need, 0);
            activeInstitutions.forEach(inst => {
                let share = Math.floor((inst.need / totalNeedOfActive) * availableQty);
                if (!forceDistCheck.checked) share = Math.min(share, inst.need);
                inst.share = share;
            });
            let distributedQty = activeInstitutions.reduce((sum, inst) => sum + inst.share, 0);
            let remainder = availableQty - distributedQty;
            activeInstitutions.sort((a, b) => (b.need / totalNeedOfActive) - (a.need / totalNeedOfActive));
            for (let i = 0; i < remainder; i++) {
                let inst = activeInstitutions[i % activeInstitutions.length];
                if (forceDistCheck.checked || inst.share < inst.need) { inst.share++; } else { remainder++; }
            }
            activeInstitutions.forEach(inst => { inst.roundedShare = Math.floor(inst.share / packageSize) * packageSize; });
            if (packageSize > 1) {
                let totalRoundedDistributed = activeInstitutions.reduce((sum, inst) => sum + inst.roundedShare, 0);
                let roundingRemainder = availableQty - totalRoundedDistributed;
                while (roundingRemainder >= packageSize) {
                    let bestCandidate = null, maxLoss = -1;
                    activeInstitutions.forEach(inst => {
                        const roundingLoss = inst.share - inst.roundedShare;
                        if (roundingLoss > maxLoss && (forceDistCheck.checked || (inst.roundedShare + packageSize <= inst.need))) { maxLoss = roundingLoss; bestCandidate = inst; }
                    });
                    if (bestCandidate) { bestCandidate.roundedShare += packageSize; roundingRemainder -= packageSize; } else { break; }
                }
            }
            displayResults(activeInstitutions, totalNeedOfActive, availableQty);
        };

        function displayResults(institutions, totalNeedOfActive, availableQty) {
            lastResultsData = institutions;
            const container = document.getElementById('results-table-container');
            const packageSize = parseInt(packageSizeInput.value, 10) || 1;
            const itemCode = selectedRowData.row[0] || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            const itemName = selectedRowData.row[1] || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            document.getElementById('print-item-name').textContent = `ØªÙ‚Ø±ÙŠØ± ØªÙˆØ²ÙŠØ¹ Ù…Ø§Ø¯Ø©: ${itemName}`;
            document.getElementById('print-item-code').textContent = `Ø§Ù„ÙƒÙˆØ¯: ${itemCode}`;
            const totalDistributed = institutions.reduce((sum, inst) => sum + inst.share, 0);
            const totalRoundedDistributed = institutions.reduce((sum, inst) => sum + inst.roundedShare, 0);
            const finalTotalDistributed = packageSize > 1 ? totalRoundedDistributed : totalDistributed;
            const overallCoveragePercentage = totalNeedOfActive > 0 ? ((finalTotalDistributed / totalNeedOfActive) * 100).toFixed(1) : 0;
            const summaryHTML = `<div class="results-summary"><span><strong>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©:</strong> ${availableQty.toLocaleString()}</span> | <span><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ²Ø¹:</strong> ${finalTotalDistributed.toLocaleString()}</span> | <span><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ø¯ÙŠÙƒ:</strong> ${(availableQty - finalTotalDistributed).toLocaleString()}</span></div>`;
            let tableHTML = summaryHTML + `<table class="results-table"><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</th><th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬</th><th>Ø§Ù„Ø­ØµØ© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©</th>`;
            if (packageSize > 1) { tableHTML += `<th>Ø§Ù„Ø­ØµØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø¨ÙˆØ§Øª</th>`; }
            tableHTML += `<th>Ø§Ù„Ù†Ø³Ø¨Ø©</th></tr></thead><tbody>`;
            institutions.forEach(inst => {
                const percentageOfTotalNeed = totalNeedOfActive > 0 ? ((inst.need / totalNeedOfActive) * 100).toFixed(1) : 0;
                tableHTML += `<tr><td>${inst.name}</td><td>${inst.need.toLocaleString()}</td><td>${inst.share.toLocaleString()}</td>`;
                if (packageSize > 1) {
                    tableHTML += `<td style="font-weight:bold; color: var(--success);">${inst.roundedShare.toLocaleString()}</td>`;
                    tableHTML += `<td>${inst.roundedShare / packageSize} Ø¹Ù„Ø¨</td>`;
                }
                tableHTML += `<td>${percentageOfTotalNeed}%</td></tr>`;
            });
            const totalPackages = packageSize > 1 ? (totalRoundedDistributed / packageSize) : 0;
            tableHTML += `</tbody><tfoot><tr><td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td><td>${totalNeedOfActive.toLocaleString()}</td><td>${totalDistributed.toLocaleString()}</td>`;
            if (packageSize > 1) { tableHTML += `<td>${totalRoundedDistributed.toLocaleString()}</td><td>${totalPackages} Ø¹Ù„Ø¨</td>`; }
            tableHTML += `<td>${overallCoveragePercentage}%</td></tr></tfoot></table>`;
            container.innerHTML = tableHTML;
            resultsSection.hidden = false;
        }

        document.getElementById('print-btn').onclick = () => window.print();
        document.getElementById('export-csv-btn').onclick = function() {
            if (lastResultsData.length === 0) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ØªØµØ¯ÙŠØ±."); return; }
            const itemName = document.getElementById('item-name-display').value;
            const packageSize = parseInt(packageSizeInput.value, 10) || 1;
            
            let csvHeaders = "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©,Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©,Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø³Ù†ÙˆÙŠ,Ø§Ù„Ø­ØµØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…ÙˆØ²Ø¹Ø©,";
            if(packageSize > 1) csvHeaders += "Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø¨ÙˆØ§Øª,";
            csvHeaders += "Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬\n";

            let csvContent = csvHeaders;
            const totalNeedOfActive = lastResultsData.reduce((sum, i) => sum + i.need, 0);
            
            lastResultsData.forEach(inst => {
                const finalShare = packageSize > 1 ? inst.roundedShare : inst.share;
                const percentageOfTotalNeed = totalNeedOfActive > 0 ? ((inst.need / totalNeedOfActive) * 100).toFixed(1) : "0.0";
                let row = `"${itemName}","${inst.name}",${inst.need},${finalShare},`;
                if(packageSize > 1) row += `"${inst.roundedShare / packageSize}",`;
                row += `"${percentageOfTotalNeed}%"`;
                csvContent += row + "\n";
            });

            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const safeItemName = itemName.replace(/[^a-z0-9]/gi, '_');
            link.setAttribute("download", `distribution_${safeItemName}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
    </script>
</body>
</html>
