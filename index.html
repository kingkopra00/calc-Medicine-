<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯ (Ø§Ù„Ù…Ø­Ø¯Ø«)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-bg: #1a1c23; --panel-bg: #252934; --accent: #007bff;
            --border: #3a3f4b; --text: #f0f0f0; --muted: #a0a0a0; --success: #28a745; --danger: #dc3545;
        }
        body { background: var(--main-bg); color: var(--text); margin: 0; font-family: "Tajawal", "Segoe UI", Arial, sans-serif; font-size: 16px; }
        main { max-width: 1000px; margin: 20px auto; padding: 1rem; }
        h1, h2, h3 { text-align: center; font-weight: 700; margin-bottom: 1em; }
        footer { text-align: center; margin-top: 2em; padding: 1em; color: var(--muted); border-top: 1px solid var(--border); }
        .section { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 1.5em; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 1em; align-items: end; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: var(--muted); }
        input, select { width: 100%; padding: 10px; background: var(--main-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .btn { background: var(--panel-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 10px 20px; font-size: 1em; cursor: pointer; width: 100%; transition: background-color 0.2s, border-color 0.2s; }
        .btn:hover { border-color: var(--accent); }
        .btn-primary { background: var(--accent); color: #fff; border: none; }
        .btn-success { background: var(--success); color: #fff; border: none; }
        .btn-danger { background-color: var(--danger); color: #fff; border: none; }
        #data-status { text-align: center; color: var(--accent); font-weight: bold; margin-bottom: 1em; min-height: 1.2em; }
        .search-wrapper { position: relative; }
        #suggestions-container {
            position: absolute; background-color: #2d3241; border: 1px solid var(--border);
            border-radius: 8px; width: 100%; z-index: 1000; max-height: 40vh; overflow-y: auto; top: 100%;
        }
        #suggestions-container.suggestions-above { top: auto; bottom: 100%; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .suggestion-item:hover { background-color: #3a3f4b; }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1001; }
        .modal-content { background: var(--panel-bg); padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .results-list-item { padding: 15px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
        .options-row { display: flex; align-items: center; gap: 10px; margin-top: 15px; padding: 12px; background: #2d3241; border-radius: 8px; }
        .results-summary { text-align: center; font-size: 1.1em; margin-bottom: 1em; background: #2d3241; padding: 10px; border-radius: 8px; }
        
        /* Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© */
        .results-table { width: 100%; border-collapse: collapse; font-size: 0.95em; margin-top: 1em; table-layout: fixed; }
        .results-table th, .results-table td { border-bottom: 1px solid var(--border); padding: 12px 8px; text-align: center; word-wrap: break-word; }
        #print-header { display: none; }
        
        /* === ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ© === */
        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            body { background: #fff; color: #000; font-family: 'Tajawal', sans-serif; -webkit-print-color-adjust: exact; }
            main, .section { margin: 0; padding: 0; border: none; box-shadow: none; background: #fff; width: 100%; max-width: 100%; }
            .no-print { display: none !important; }
            
            #print-header { 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                border-bottom: 3px double #000; 
                padding-bottom: 10px; 
                margin-bottom: 20px;
            }
            #print-header div { text-align: center; }
            #print-header h1 { font-size: 18pt; margin: 5px 0; color: #000; text-decoration: underline; }
            #print-header p { margin: 2px 0; font-size: 11pt; }
            
            h2 { display: none; }
            
            .results-table { 
                width: 100%; border-collapse: collapse; font-size: 10pt; direction: rtl; 
                border: 2px solid #000; margin-top: 10px;
            }
            .results-table th { 
                background-color: #f0f0f0 !important; color: #000; font-weight: bold; border: 1px solid #000; padding: 6px; 
            }
            .results-table td { 
                border: 1px solid #000; padding: 5px; text-align: center; vertical-align: middle;
            }
            .results-table tfoot { font-weight: bold; background-color: #e0e0e0 !important; }
            
            tr { page-break-inside: avoid; }
            thead { display: table-header-group; }

            footer { 
                display: flex !important; justify-content: space-between; margin-top: 30px; 
                border-top: none; padding-top: 20px; page-break-inside: avoid;
            }
            footer p { font-size: 12pt; font-weight: bold; color: #000; }
        }
    </style>
</head>
<body>
    <main>
        <h1 class="no-print">ğŸ“‹ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯</h1>
        
        <div class="section no-print">
            <h2>Ø§Ù„Ø®Ø·ÙˆØ© 1: Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
            <p id="data-status">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø¨Ø¯Ø¡...</p>
            <div class="form-row">
                <div>
                    <label>ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Github)</label>
                    <select id="year-select">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù --</option>
                        <option value="cancer_2026" style="font-weight: bold; color: #e83e8c;">ğŸ’Š Ø£Ø¯ÙˆÙŠØ© Ù…Ø¹ØªÙ…Ø¯ 2026</option>
                        <option value="cancer_approved_2026" style="font-weight: bold; color: #d63384;">ğŸ§ª Ø³Ø±Ø·Ø§Ù†ÙŠØ© Ù…Ø¹ØªÙ…Ø¯ 2026 (Ø§Ù„Ø¬Ø¯ÙŠØ¯)</option>
                        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                        </select>
                </div>
                <div><button id="load-from-server-btn" class="btn btn-success">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±</button></div>
            </div>
            <hr style="border-color: var(--border); margin: 2em 0;">
            <div class="form-row">
                <div><label>... Ø£Ùˆ Ø±ÙØ¹ Ù…Ù„Ù Ù…Ø­Ù„ÙŠ (ÙŠØ¯Ø¹Ù… ÙƒØ§ÙØ© Ø§Ù„ØµÙŠØº)</label><input type="file" id="excel-file-input" accept=".xlsx, .xls"></div>
                <div><button id="load-excel-btn" class="btn">ğŸ“‚ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ</button></div>
            </div>
            <hr style="border-color: var(--border); margin: 2em 0;">
            
            <div class="form-row">
                <div class="search-wrapper">
                    <label for="item-name-search">Ø¨Ø­Ø« Ø´Ø§Ù…Ù„ (Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯/National Code)</label>
                    <input type="text" id="item-name-search" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«...">
                    <div id="suggestions-container"></div>
                </div>
                <div><label style="visibility: hidden;">.</label><button id="search-excel-btn" class="btn btn-primary">ğŸ” Ø¨Ø­Ø«</button></div>
            </div>
            <div id="reset-button-container" class="form-row" hidden>
                <button id="reset-btn" class="btn btn-danger">ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
            </div>
        </div>
        
        <div class="section no-print" id="config-section" hidden>
            <h2>Ø§Ù„Ø®Ø·ÙˆØ© 2: Ù„ÙˆØ­Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹</h2>
            <div class="form-row">
                 <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</label><input type="text" id="item-name-display" readonly></div>
                 <div><label>Ø§Ù„ÙƒÙˆØ¯ / Ø§Ù„Ø±Ù…Ø²</label><input type="text" id="item-code-display" readonly></div>
                <div><label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬</label><input type="text" id="total-need-display" readonly></div>
            </div>
            
            <label>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† (ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù):</label>
            <div id="institutions-toggle-list"></div>
            
            <div class="options-row">
                <input type="checkbox" id="force-full-dist-check" style="width: 20px; height: 20px;">
                <label for="force-full-dist-check" style="margin: 0;">ØªÙˆØ²ÙŠØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© (ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø¯)</label>
            </div>
            
            <div class="form-row" style="margin-top: 20px;">
                 <div>
                    <label>âœ… Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙØ± Ù„Ù„ØªÙˆØ²ÙŠØ¹</label>
                    <input type="text" id="available-qty-input" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ" inputmode="numeric">
                </div>
                <div>
                    <label>ğŸ“¦ Ø³Ø¹Ø© Ø§Ù„Ø¹Ø¨ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" id="package-size-input" placeholder="Ù…Ø«Ø§Ù„: 10" inputmode="numeric">
                </div>
                 <div><button id="calculate-btn" class="btn btn-success">ğŸ§® ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­ØµØµ</button></div>
            </div>
        </div>

        <div class="section" id="results-section" hidden>
            <div id="print-header">
                <div>
                    <p>Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚</p>
                    <p>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø© / Ø¯Ø§Ø¦Ø±Ø© ØµØ­Ø© Ø§Ù„Ù…Ø«Ù†Ù‰</p>
                </div>
                <div>
                    <h1 id="print-item-name"></h1>
                    <p id="print-item-code"></p>
                </div>
                <div>
                    <p id="print-date"></p>
                    <p id="print-available-qty"></p>
                </div>
            </div>
            <h2 class="no-print">Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2>
            <div id="results-table-container"></div>
            <div class="form-row no-print" style="margin-top: 20px;">
                <button id="print-btn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø±Ø³Ù…ÙŠØ©</button>
                <button id="export-csv-btn" class="btn" style="background-color: #17a2b8; border:none;">ğŸ’¾ Ø­ÙØ¸ Excel/CSV</button>
            </div>
        </div>

        <div class="modal-bg no-print" id="multi-results-modal">
            <div class="modal-content">
                <h3>Ù†ØªØ§Ø¦Ø¬ Ù…ØªØ¹Ø¯Ø¯Ø©ØŒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</h3>
                <div id="results-list"></div>
            </div>
        </div>

        <footer class="no-print">
            <p>ØªÙ… Ø§Ù„ØªØµÙ…ÙŠÙ…: Ø§Ù„ØµÙŠØ¯Ù„Ø§Ù†ÙŠ Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø­Ø³Ù† Ø§Ù„Ù†Ø§Ø¬ÙŠ</p>
            <p>Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„Ø© - Ø¯Ø§Ø¦Ø±Ø© ØµØ­Ø© Ø§Ù„Ù…Ø«Ù†Ù‰</p>
        </footer>
    </main>
    
    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let excelData = { headers: [], rows: [] };
        let selectedRowData = { row: null, institutions: [] };
        let lastResultsData = [];
        const REPO_OWNER = 'kingkopra00';
        const REPO_NAME = 'calc-Medicine-';
        
        // Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ù„ÙØ§Øª
        const CANCER_FILE_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/%D8%A7%D8%AF%D9%88%D9%8A%D8%A9%20%D9%85%D8%B9%D8%AA%D9%85%D8%AF%20%202026.xlsx`;
        const CANCER_APPROVED_FILE_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/%D8%B3%D8%B1%D8%B7%D8%A7%D9%86%D9%8A%D8%A9%20%D9%85%D8%B9%D8%AA%D9%85%D8%AF%202026.xlsx`;

        // Ø¹Ù†Ø§ØµØ± DOM
        const inputs = {
            search: document.getElementById('item-name-search'),
            suggestions: document.getElementById('suggestions-container'),
            availQty: document.getElementById('available-qty-input'),
            pkgSize: document.getElementById('package-size-input'),
            forceCheck: document.getElementById('force-full-dist-check'),
            yearSelect: document.getElementById('year-select')
        };
        
        let debounceTimer;

        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocal();
            discoverAvailableYears();
            if (localStorage.getItem('forceFullDistSetting') === 'true') inputs.forceCheck.checked = true;
            inputs.forceCheck.onchange = (e) => localStorage.setItem('forceFullDistSetting', e.target.checked);
        });

        // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† GitHub
        async function discoverAvailableYears() {
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/`);
                if (!response.ok) return; 
                const files = await response.json();
                
                const yearRegex = /^data(\d{4})\.xlsx$/i;
                files.forEach(file => {
                    const match = file.name.match(yearRegex);
                    if (match) {
                        const opt = document.createElement('option');
                        opt.value = match[1];
                        opt.textContent = `Ø§Ø­ØªÙŠØ§Ø¬ Ø¹Ø§Ù… ${match[1]} (ØªÙˆØ²ÙŠØ¹ Ù…Ø¤Ø³Ø³Ø§Øª)`;
                        inputs.yearSelect.appendChild(opt);
                    }
                });
            } catch (e) { console.log("GitHub API Limit or Offline"); }
        }

        // Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        document.getElementById('load-from-server-btn').onclick = function() {
            const val = inputs.yearSelect.value;
            if (!val) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù.'); return; }

            const statusEl = document.getElementById('data-status');
            let url = "";

            // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø©
            if (val === 'cancer_2026') {
                url = CANCER_FILE_URL;
            } else if (val === 'cancer_approved_2026') {
                url = CANCER_APPROVED_FILE_URL;
            } else {
                url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/data${val}.xlsx`;
            }
            
            url += `?t=${Date.now()}`; // Ù…Ù†Ø¹ Ø§Ù„ÙƒØ§Ø´
            statusEl.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...`;

            fetch(url)
                .then(res => { if (!res.ok) throw new Error("ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†ØªØ±Ù†Øª)"); return res.arrayBuffer(); })
                .then(buff => processExcelData(new Uint8Array(buff), 'array'))
                .catch(err => { alert(err.message); statusEl.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„"; });
        };

        // Ø²Ø± Ø±ÙØ¹ Ù…Ù„Ù Ù…Ø­Ù„ÙŠ
        document.getElementById('load-excel-btn').onclick = () => {
            const fileInput = document.getElementById('excel-file-input');
            if (!fileInput.files.length) { alert("Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹"); return; }
            const reader = new FileReader();
            reader.onload = e => processExcelData(e.target.result, 'binary');
            reader.readAsBinaryString(fileInput.files[0]);
        };

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Core Logic)
        function processExcelData(data, type) {
            try {
                const workbook = XLSX.read(data, {type: type});
                const firstSheet = workbook.SheetNames[0];
                const rawRows = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { header: 1 });

                if (rawRows.length < 2) throw new Error("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº");

                let headerIdx = -1;
                for (let i = 0; i < Math.min(30, rawRows.length); i++) {
                    const rowStr = rawRows[i].join(' ').toLowerCase();
                    if (rowStr.includes('code') || rowStr.includes('items') || rowStr.includes('Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©') || rowStr.includes('Ø±Ù…Ø²')) {
                        headerIdx = i;
                        break;
                    }
                }
                if (headerIdx === -1) headerIdx = 0;

                excelData = {
                    headers: rawRows[headerIdx],
                    rows: rawRows.slice(headerIdx + 1)
                };

                try { localStorage.setItem('unifiedMedData', JSON.stringify(excelData)); } 
                catch (e) { console.warn("Local storage full, skipping save"); }

                document.getElementById('data-status').textContent = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${excelData.rows.length} Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­.`;
                document.getElementById('reset-button-container').hidden = false;

            } catch (err) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: " + err.message);
            }
        }

        // === Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ (Fixed & Safe) ===
        function findColIndex(headers, keywords) {
            if (!headers) return -1;
            const safeHeaders = [];
            for (let i = 0; i < headers.length; i++) {
                safeHeaders[i] = headers[i] ? String(headers[i]).toLowerCase().trim() : "";
            }
            for (let kw of keywords) {
                const kwClean = kw.toLowerCase();
                const idx = safeHeaders.findIndex(h => h && (h === kwClean || h.includes(kwClean)));
                if (idx !== -1) return idx;
            }
            return -1;
        }

        inputs.search.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const query = normalizeText(inputs.search.value);
                inputs.suggestions.innerHTML = '';
                if (query.length < 2 || !excelData.rows.length) return;

                const nameIdx = findColIndex(excelData.headers, ["items", "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©", "Ø§Ù„Ù…Ø§Ø¯Ø©", "name"]);
                const codeIdx = findColIndex(excelData.headers, ["national code", "code", "Ø±Ù…Ø²", "Ø§Ù„ÙƒÙˆØ¯"]);

                const results = excelData.rows.filter(row => {
                    const name = row[nameIdx];
                    const code = (codeIdx !== -1) ? row[codeIdx] : '';
                    return (name && normalizeText(name).includes(query)) || 
                           (code && normalizeText(code).includes(query));
                }).slice(0, 15);

                results.forEach(row => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    const dName = row[nameIdx] || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
                    const dCode = (codeIdx !== -1) ? row[codeIdx] : "";
                    
                    div.innerHTML = dCode ? `<strong>${dCode}</strong> - ${dName}` : dName;
                    div.onclick = () => {
                        inputs.search.value = dName;
                        inputs.suggestions.innerHTML = '';
                        populateConfigSection(row);
                    };
                    inputs.suggestions.appendChild(div);
                });
                
                const rect = inputs.search.getBoundingClientRect();
                if (window.innerHeight - rect.bottom < 200) inputs.suggestions.classList.add('suggestions-above');
                else inputs.suggestions.classList.remove('suggestions-above');

            }, 300);
        });

        function populateConfigSection(row) {
            document.getElementById('config-section').hidden = false;
            document.getElementById('results-section').hidden = true;
            inputs.availQty.value = '';
            
            const nameIdx = findColIndex(excelData.headers, ["items", "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©", "name"]);
            const codeIdx = findColIndex(excelData.headers, ["national code", "code", "Ø§Ù„ÙƒÙˆØ¯", "Ø±Ù…Ø²"]);
            let totalIdx = findColIndex(excelData.headers, ["Ø¯Ø§Ø¦Ø±Ø© ØµØ­Ø© Ø§Ù„Ù…Ø«Ù†Ù‰", "Ø§Ù„Ù…Ø«Ù†Ù‰", "total need", "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬", "Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„ÙƒÙ„ÙŠ"]);
            
            if (totalIdx === -1) {
                for (let i = row.length - 1; i >= 0; i--) {
                    if (typeof row[i] === 'number' && row[i] > 0) { totalIdx = i; break; }
                }
            }

            document.getElementById('item-name-display').value = row[nameIdx] || '-';
            document.getElementById('item-code-display').value = (codeIdx !== -1) ? row[codeIdx] : '-';
            const totalVal = (totalIdx !== -1) ? (parseInt(row[totalIdx]) || 0) : 0;
            document.getElementById('total-need-display').value = totalVal.toLocaleString();

            const institutions = [];
            const instKeywords = ["Ù…Ø³ØªØ´ÙÙ‰", "Ù‚Ø·Ø§Ø¹", "Ù…Ø±ÙƒØ²", "ØªØ£Ù‡ÙŠÙ„", "Ø¹ÙŠØ§Ø¯Ø©", "Ù…Ø®Ø²Ù†"];
            let foundIndividualInsts = false;

            excelData.headers.forEach((h, i) => {
                if (!h || i === nameIdx || i === codeIdx || i === totalIdx) return;
                const hClean = String(h).toLowerCase();
                if (["Ù…Ù„Ø§Ø­Ø¸Ø§Øª", "unit", "level", "notes", "Ù‚ÙŠØ§Ø³"].some(x => hClean.includes(x))) return;

                const val = parseInt(row[i]) || 0;
                if (instKeywords.some(k => hClean.includes(k)) && val > 0) {
                    institutions.push({ name: h, need: val });
                    foundIndividualInsts = true;
                }
            });

            if (!foundIndividualInsts && totalVal > 0) {
                institutions.push({ 
                    name: "Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ / Ù…Ø±ÙƒØ² Ø§Ù„Ø£ÙˆØ±Ø§Ù…", 
                    need: totalVal 
                });
            }

            selectedRowData = { row, institutions };
            renderInstitutionsTable(institutions);
        }

        function renderInstitutionsTable(list) {
            const container = document.getElementById('institutions-toggle-list');
            let html = `<table class="results-table">
                <thead><tr>
                    <th style="width:30px"><input type="checkbox" id="toggle-all" checked></th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©</th>
                    <th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬</th>
                    <th>Ø³Ù‚Ù Ø§Ù„ØªÙˆØ²ÙŠØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</th>
                </tr></thead><tbody>`;
            
            list.forEach(inst => {
                html += `<tr>
                    <td><input type="checkbox" class="inst-check" data-name="${inst.name}" checked></td>
                    <td>${inst.name}</td>
                    <td>${inst.need.toLocaleString()}</td>
                    <td><input type="text" class="max-input" data-name="${inst.name}" placeholder="Ø¨Ù„Ø§ Ø­Ø¯" oninput="this.value=this.value.replace(/[^0-9]/g,'')"></td>
                </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;

            document.getElementById('toggle-all').onclick = (e) => {
                document.querySelectorAll('.inst-check').forEach(c => c.checked = e.target.checked);
            };
        }

        document.getElementById('calculate-btn').onclick = () => {
            const avail = parseInt(inputs.availQty.value) || 0;
            const pkg = parseInt(inputs.pkgSize.value) || 1;
            
            if (avail <= 0) { alert("Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©"); return; }

            const activeInsts = [];
            const checkboxes = document.querySelectorAll('.inst-check:checked');
            
            if (!checkboxes.length) { alert("Ø§Ø®ØªØ± Ù…Ø³ØªÙÙŠØ¯Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return; }

            checkboxes.forEach(chk => {
                const name = chk.dataset.name;
                const original = selectedRowData.institutions.find(i => i.name === name);
                const maxInput = document.querySelector(`.max-input[data-name="${name}"]`);
                const maxVal = maxInput.value ? parseInt(maxInput.value) : Infinity;
                activeInsts.push({ ...original, max: maxVal, share: 0, final: 0 });
            });

            const totalNeed = activeInsts.reduce((s, i) => s + i.need, 0);

            activeInsts.forEach(inst => {
                let share = (totalNeed > 0) ? (inst.need / totalNeed) * avail : (avail / activeInsts.length);
                let limit = inputs.forceCheck.checked ? Infinity : inst.need;
                if (inst.max !== Infinity) limit = Math.min(limit, inst.max);
                inst.rawShare = Math.min(share, limit);
                inst.share = Math.floor(inst.rawShare);
            });

            let distributed = activeInsts.reduce((s, i) => s + i.share, 0);
            let remainder = avail - distributed;
            
            if (remainder > 0) {
                activeInsts.sort((a, b) => (b.rawShare - b.share) - (a.rawShare - a.share));
                let i = 0;
                while (remainder > 0) {
                    const inst = activeInsts[i % activeInsts.length];
                    let limit = inputs.forceCheck.checked ? Infinity : inst.need;
                    if (inst.max !== Infinity) limit = Math.min(limit, inst.max);
                    if (inst.share < limit) {
                        inst.share++;
                        remainder--;
                    } else if (i > activeInsts.length * 2) { break; }
                    i++;
                }
            }

            if (pkg > 1) {
                activeInsts.forEach(inst => inst.final = Math.floor(inst.share / pkg) * pkg);
                let distFinal = activeInsts.reduce((s, i) => s + i.final, 0);
                let stockLeft = avail - distFinal;
                activeInsts.sort((a, b) => (a.share - a.final) - (b.share - b.final)).reverse();
                for (let inst of activeInsts) {
                    if (stockLeft >= pkg) {
                        let limit = inputs.forceCheck.checked ? Infinity : inst.need;
                        if (inst.max !== Infinity) limit = Math.min(limit, inst.max);
                        if (inst.final + pkg <= limit * 1.1 || inputs.forceCheck.checked) {
                            inst.final += pkg;
                            stockLeft -= pkg;
                        }
                    }
                }
            } else {
                activeInsts.forEach(inst => inst.final = inst.share);
            }

            showResults(activeInsts, totalNeed, avail, pkg);
        };

        function showResults(list, totalNeed, avail, pkg) {
            lastResultsData = list;
            const container = document.getElementById('results-table-container');
            const itemName = document.getElementById('item-name-display').value;
            const itemCode = document.getElementById('item-code-display').value;
            
            document.getElementById('print-item-name').textContent = itemName;
            document.getElementById('print-item-code').textContent = itemCode;
            document.getElementById('print-date').textContent = new Date().toLocaleDateString('ar-IQ');
            
            const totalFinal = list.reduce((s, i) => s + i.final, 0);

            let html = `<div class="results-summary no-print">
                <span>Ø§Ù„Ù…ØªÙˆÙØ±: ${avail}</span> | 
                <span>Ø§Ù„Ù…ÙˆØ²Ø¹: ${totalFinal}</span> | 
                <span style="color:${(avail-totalFinal)>0?'var(--accent)':'var(--success)'}">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${avail - totalFinal}</span>
            </div>`;

            html += `<table class="results-table"><thead><tr>
                <th>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©</th>
                <th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬</th>
                <th>Ø§Ù„Ø­ØµØ© (ÙˆØ­Ø¯Ø©)</th>
                ${pkg > 1 ? '<th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø¨ÙˆØ§Øª</th>' : ''}
                <th>Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ©</th>
            </tr></thead><tbody>`;

            list.forEach(inst => {
                const percent = inst.need ? Math.round((inst.final / inst.need) * 100) : 0;
                html += `<tr>
                    <td>${inst.name}</td>
                    <td>${inst.need.toLocaleString()}</td>
                    <td style="font-weight:bold; color:var(--success)">${inst.final.toLocaleString()}</td>
                    ${pkg > 1 ? `<td>${inst.final / pkg}</td>` : ''}
                    <td>${percent}%</td>
                </tr>`;
            });

            html += `</tbody><tfoot><tr>
                <td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
                <td>${totalNeed.toLocaleString()}</td>
                <td>${totalFinal.toLocaleString()}</td>
                ${pkg > 1 ? `<td>${totalFinal / pkg}</td>` : ''}
                <td>-</td>
            </tr></tfoot></table>`;

            container.innerHTML = html;
            document.getElementById('results-section').hidden = false;
        }

        function normalizeText(txt) { return String(txt).toLowerCase().trim(); }
        inputs.availQty.oninput = function(){ this.value = this.value.replace(/[^0-9]/g, ''); }
        inputs.pkgSize.oninput = function(){ this.value = this.value.replace(/[^0-9]/g, ''); }

        function loadDataFromLocal() {
            const data = localStorage.getItem('unifiedMedData');
            if (data) {
                try {
                    excelData = JSON.parse(data);
                    document.getElementById('data-status').textContent = "âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©";
                    document.getElementById('reset-button-container').hidden = false;
                } catch(e){}
            }
        }
        
        document.getElementById('reset-btn').onclick = () => {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ØŸ")) {
                document.getElementById('config-section').hidden = true;
                document.getElementById('results-section').hidden = true;
                inputs.search.value = '';
                document.getElementById('reset-button-container').hidden = true;
                window.scrollTo(0,0);
            }
        };

        document.getElementById('print-btn').onclick = () => window.print();

        document.getElementById('search-excel-btn').onclick = () => {
             const query = normalizeText(inputs.search.value);
             if(!query) return alert("Ø£Ø¯Ø®Ù„ Ù†ØµØ§Ù‹ Ù„Ù„Ø¨Ø­Ø«");
             const nameIdx = findColIndex(excelData.headers, ["items", "Ø§Ø³Ù…", "name"]);
             const codeIdx = findColIndex(excelData.headers, ["code", "national", "ÙƒÙˆØ¯"]);
             const results = excelData.rows.filter(row => {
                 return (row[nameIdx] && normalizeText(row[nameIdx]).includes(query)) ||
                        (codeIdx!==-1 && row[codeIdx] && normalizeText(row[codeIdx]).includes(query));
             });
             
             if(results.length === 1) populateConfigSection(results[0]);
             else if(results.length > 1) {
                 const list = document.getElementById('results-list');
                 list.innerHTML = '';
                 results.forEach(r => {
                     const d = document.createElement('div');
                     d.className = 'results-list-item';
                     d.textContent = r[nameIdx];
                     d.onclick = () => { populateConfigSection(r); document.getElementById('multi-results-modal').style.display='none'; };
                     list.appendChild(d);
                 });
                 document.getElementById('multi-results-modal').style.display='flex';
             } else alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬");
        };
        
        document.getElementById('multi-results-modal').onclick = (e) => {
            if(e.target.className === 'modal-bg') e.target.style.display = 'none';
        };

    </script>
</body>
</html>
